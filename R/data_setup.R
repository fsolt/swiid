if (!require(pacman)) install.packages("pacman"); library(pacman)
p_load(tidyverse, readxl, 
       eurostat, pipr, rsdmx, xml2, rvest, csodata,
       countrycode, janitor, pdftools, ipeadatar,
       statcanR, docxtractr)
install.packages("tabulapdf", repos = c("https://ropensci.r-universe.dev", "https://cloud.r-project.org"))
library(tabulapdf)
p_load_gh("worldbank/pipr")
p_load_gh("ropengov/dkstat")
p_load_gh("ropengov/pxweb")

# Custom country codes (defined in R/cc_swiid.R)
load("data/cc_swiid.rda")

# LIS
format_lis <- function(x) {
  paste0("https://raw.githubusercontent.com/fsolt/swiid/master/data-raw/LISSY/", 
         x, ".txt") %>%
    readLines() %>% 
    str_subset("^\\D{2}\\d{2}h,.*") %>%
    paste(collapse = "\n") %>% 
    read_csv(col_names = FALSE, col_types = "ccddd") %>%
    separate(X2, into = c("wd", "es"), sep = "_") %>% 
    pivot_wider(names_from = "wd",
                values_from = c("X3", "X4")) %>% 
    {if (!"X3_disp" %in% names(.)) mutate(., X3_disp = 1) else .} %>% 
    {if (!"X3_gross" %in% names(.)) mutate(., X3_gross = 1) else .} %>% 
    {if (!"X4_con" %in% names(.)) mutate(., X4_con = 1) else .} %>% 
    mutate(X3_market = if_else(!X3_market==X3_disp, X3_market, NA_real_),
           X3_gross = if_else(!X3_gross==X3_disp, X3_gross, NA_real_)) %>% 
    pivot_longer(cols = X3_market:X4_con,
                 names_to = c("var", "wd"),
                 names_sep = "_",
                 values_to = "value") %>% 
    pivot_wider(names_from = "var",
                values_from = "value") %>% 
    filter(!is.na(X3) & !X3 == 1 & !X4 == 1) %>% 
    transmute(country = str_extract(X1, "\\D{2}") %>%
                toupper() %>% 
                str_replace("UK", "GB") %>% 
                countrycode("iso2c", "swiid.name", custom_dict = cc_swiid),
              year = ifelse(str_extract(X1, "\\d{2}") %>% as.numeric() > 50,
                            str_extract(X1, "\\d{2}") %>% as.numeric() + 1900,
                            str_extract(X1, "\\d{2}") %>% as.numeric() + 2000),
              gini = (str_trim(X3) %>% as.numeric()),
              gini_se = (str_trim(X4) %>% as.numeric()),
              welfare_def = wd,
              equiv_scale = es,
              monetary = FALSE,
              series = paste("LIS", welfare_def, equiv_scale),
              source1 = "LISSY",
              page = "",
              link = paste0("https://raw.githubusercontent.com/fsolt/swiid/master/data-raw/LISSY/",
                            x, ".txt")) %>% 
    filter(!gini == 0 & !(gini>.85 & welfare_def == "con")) %>% 
    arrange(country, year)
}

format_lis_xtra <- function(x) {
  paste0("https://raw.githubusercontent.com/fsolt/swiid/master/data-raw/LISSY/", 
         x, ".txt") %>%
    read_lines() %>% 
    str_subset("^\\D{2}\\d{2}.?,.*") %>%
    paste(collapse = "\n") %>% 
    read_csv(col_names = FALSE, show_col_types = FALSE) %>%
    transmute(country = str_extract(X1, "\\D{2}") %>% 
                toupper() %>% 
                countrycode("iso2c", "swiid.name", custom_dict = cc_swiid),
              year = ifelse(str_extract(X1, "\\d{2}") %>% as.numeric() > 66,
                            str_extract(X1, "\\d{2}") %>% as.numeric() + 1900,
                            str_extract(X1, "\\d{2}") %>% as.numeric() + 2000),
              gini = (str_trim(X2) %>% as.numeric()),
              gini_se = (str_trim(X3) %>% as.numeric()),
              equiv_scale = "sqrt",
              welfare_def = "disp",
              monetary = FALSE,
              series = "LIS disp sqrt",
              source1 = ifelse(country=="New Zealand", "Statistics New Zealand 1999", "LIS Key Figures"),
              page = ifelse(country=="New Zealand", "73", ""),
              link = ifelse(country=="New Zealand", 
                            "https://web.archive.org/web/20170407020304/http://www2.stats.govt.nz/domino/external/pasfull/pasfull.nsf/84bf91b1a7b5d7204c256809000460a4/4c2567ef00247c6acc256b03000bdbe0/$FILE/Incomes.pdf", 
                            "https://web.archive.org/web/20100804001129/http://www.lisproject.org/key-figures/kf-workbook.xls")) %>% 
    arrange(country, year)
}

format_lis_archived <- function(link) {
  x <- str_extract(link, "[a-z]{2}(?=\\.txt)")
  
  link %>% 
  readLines() %>% 
  str_subset("^\\D{2}\\d{2}h,.*") %>%
  paste(collapse = "\n") %>% 
  read_csv(col_names = FALSE, col_types = "ccddd") %>%
  separate(X2, into = c("wd", "es"), sep = "_") %>% 
  pivot_wider(names_from = "wd",
              values_from = c("X3", "X4")) %>% 
  {if (!"X3_disp" %in% names(.)) mutate(., X3_disp = 1) else .} %>% 
  {if (!"X3_gross" %in% names(.)) mutate(., X3_gross = 1) else .} %>% 
  {if (!"X4_con" %in% names(.)) mutate(., X4_con = 1) else .} %>% 
  mutate(X3_market = if_else(!X3_market==X3_disp, X3_market, NA_real_),
         X3_gross = if_else(!X3_gross==X3_disp, X3_gross, NA_real_)) %>% 
  pivot_longer(cols = X3_market:X4_con,
               names_to = c("var", "wd"),
               names_sep = "_",
               values_to = "value") %>% 
  pivot_wider(names_from = "var",
              values_from = "value") %>% 
  filter(!is.na(X3) & !X3 == 1 & !X4 == 1) %>% 
  transmute(country = str_extract(X1, "\\D{2}") %>%
              toupper() %>% 
              str_replace("UK", "GB") %>% 
              countrycode("iso2c", "swiid.name", custom_dict = cc_swiid),
            year = ifelse(str_extract(X1, "\\d{2}") %>% as.numeric() > 50,
                          str_extract(X1, "\\d{2}") %>% as.numeric() + 1900,
                          str_extract(X1, "\\d{2}") %>% as.numeric() + 2000),
            gini = (str_trim(X3) %>% as.numeric()),
            gini_se = (str_trim(X4) %>% as.numeric()),
            welfare_def = wd,
            equiv_scale = es,
            monetary = FALSE,
            series = paste("LIS", welfare_def, equiv_scale),
            source1 = "LISSY",
            page = "",
            link = link) %>% 
  filter(!gini == 0 & !(gini>.85 & welfare_def == "con")) %>% 
  arrange(country, year)
}

lis_eg_link <- "https://raw.githubusercontent.com/fsolt/swiid/5e4ecaca2aa7780f3d6892488d5d61a47bc4869c/data-raw/LISSY/eg.txt"

lis_files <- c("au", "at", "be", "br", "ca", "ci", "cl", "cn", "co",
               "cz", "dk",
               "do", "ee", "fi", "fr", "de", "ge", "gr", "gt",
               "hu", "is", 
               "in", "ie", "il", "it", "jp", "lt", "lu", "ml",
               "mx", "nl", "no", "pa", "py", 
               "pe", "pl", "ro", "ru", "rs", "sk", "si",
               "za", "kr", "es", "se", 
               "ch", "tw", "uk", "us", "uy", "vn") 

erflis_files <- c("eg", "iq", "jo", "ps", "sd") # "so", "tn"

lis <- lis_files %>% 
  map_df(format_lis) %>% 
  bind_rows(format_lis_xtra("nz")) %>%
  bind_rows(format_lis_archived(lis_eg_link)) %>% 
  arrange(country, year, welfare_def, equiv_scale)

erflis <- erflis_files %>% 
  map_df(format_lis) %>% 
  mutate(series = str_replace(series, "LIS", "ERF-LIS"))

ru_lis_old <- format_lis_xtra("ru_old") %>% 
  mutate(series = "LIS Key Figures Russia disp sqrt")


# Socio-Economic Database for Latin America and the Caribbean (SEDLAC) (update link)
format_sedlac <- function(df, sheet, link, es) {
  x <- df
  if(ncol(x)==2) {
    x$se <- NA
  }
  names(x) <- c("heading", "gini", "se")
  x <- x %>%
    filter(!is.na(heading) & !str_detect(heading, "-II"))
  countries_sedlac <- "Argentina|Bolivia|Brazil|Chile|Colombia|Costa|Dominican|Ecuador|El Salvador|Guatemala|Honduras|Mexico|Nicaragua|Panama|Paraguay|Peru|Uruguay|Venezuela|Caribbean|Belice|Guyana|Haiti|Jamaica|Suriname"
  x$h_co <- str_detect(x$heading, countries_sedlac)
  x$country <- ifelse(x$h_co, str_trim(x$heading), NA)
  if (is.na(x$country[1])) {
    x$country <- c(NA, zoo::na.locf(x$country))
  } else {
    x$country <- zoo::na.locf(x$country)
  }
  x$country <- x$country %>% 
    str_replace("Dominican Rep.", "Dominican Republic") %>% 
    str_replace("Belice", "Belize")
  
  x$year <- ifelse(str_detect(x$heading, ".*(\\d{4}).*"),
                   str_replace(x$heading, "(\\d{4}).*", "\\1"), NA)
  x <- x %>% 
    mutate(h_ser = !h_co & is.na(year),
           series = ifelse(!x$h_co & is.na(x$year), x$heading, NA))
  
  x <- x %>%
    group_by(country) %>%
    mutate(series0 = zoo::na.locf(series, na.rm = FALSE) %>% 
             if_else(country=="Chile" & is.na(.), "old", .) %>% 
             if_else(country=="Costa Rica" & year=="2010" & is.na(lag(year)), "ENAHO-EHPM", .),
           series = paste("SEDLAC", country, "disp", es,
                          as.numeric(factor(series0, levels = unique(series0)))) %>% 
             str_replace("NA", "1")) %>% 
    ungroup() %>% 
    transmute(country = country,
              year = as.numeric(year),
              gini = as.numeric(gini),
              gini_se = se,
              welfare_def = "disp",
              equiv_scale = es,
              monetary = TRUE,
              series = series,
              source1 = "SEDLAC",
              page = sheet, 
              link = link) %>% 
    filter(!is.na(gini))
  
  return(x)
}

sedlac_link <- "https://www.cedlas.econo.unlp.edu.ar/wp/wp-content/uploads/2024_Act1_inequality_LAC.xlsx"
download.file(sedlac_link, "data-raw/sedlac.xlsx")

sedlac_pc <- read_excel(path = "data-raw/sedlac.xlsx", 
                        sheet = "intervals pci",
                        skip = 8)[1:3] %>%
  format_sedlac(sheet = "intervals pci",
                link = sedlac_link,
                es = "pc") 

sedlac_ei <- read_excel(path = "data-raw/sedlac.xlsx",
                        sheet = "intervals ei",
                        skip = 8)[1:3] %>%
  format_sedlac(sheet = "intervals ei",
                link = sedlac_link,
                es = "ae")

sedlac_hh <- read_excel(path = "data-raw/sedlac.xlsx",
                        sheet = "gini1",
                        skip = 7)[c(1,8)] %>%
  format_sedlac(sheet = "gini1",
                link = sedlac_link,
                es = "hh")

sedlac <- rbind(sedlac_ei, sedlac_hh, sedlac_pc) %>% 
  filter(!is.na(gini))

rm(sedlac_ei, sedlac_hh, sedlac_pc)


# CEPALStat (automated)
cepal_link <- "https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/3289/data"

cepal0 <- cepal_link %>% 
  jsonlite::fromJSON()

n_notes <- cepal0 %>% 
  pluck("body") %>% 
  pluck("data") %>%
  mutate(n_notes = (str_count(notes_ids, ",") + 1)) %>% 
  pull(n_notes) %>% 
  max()

cepal <- cepal0 %>% 
  pluck("body") %>% 
  pluck("data") %>% 
  left_join(cepal0 %>% 
              pluck("body") %>% 
              pluck("dimensions") %>% 
              pluck("members") %>% 
              nth(2) %>% 
              select(year = order, 
                     dim_29117 = id),
            by = "dim_29117") %>% 
  left_join(cepal0 %>% 
              pluck("body") %>% 
              pluck("dimensions") %>% 
              pluck("members") %>% 
              nth(3) %>% 
              select(area = name, 
                     dim_326 = id),
            by = "dim_326") %>% 
  mutate(country = countrycode(iso3, 
                               origin = "iso3c", 
                               destination = "swiid.name",
                               custom_dict = cc_swiid)) %>% 
  filter(!is.na(country)) %>%
  group_by(country, area) %>% 
  mutate(series = as.numeric(as.factor(notes_ids))) %>% 
  ungroup() %>% 
  filter(area == "National" |
           (area == "Urban" & 
              (country == "Argentina" | country == "Uruguay"))) %>% 
  group_by(country) %>% 
  transmute(year = year,
            gini = as.numeric(as.character(value)),
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = TRUE,
            notes = paste(area, series),
            series = paste("CEPALStat", country, "disp pc", as.numeric(factor(notes, levels = unique(notes)))),
            source1 = "CEPALStat",
            page = NA,
            link = cepal_link) %>% 
  ungroup() %>% 
  select(-notes) %>% 
  arrange(country, year, series)

# CEPAL Serie Distribución del Ingreso (archived)
cepal_sdi <- read_tsv("data-raw/repositorio_cepal.tsv",
                      col_types = "ciiccccccc") %>% 
  transmute(country = country,
            year = year,
            gini = gini/100,
            gini_se = NA,
            monetary = str_detect(welfare_def, "Monetary"),
            welfare_def = case_when(str_detect(welfare_def, "Disposable") ~ "disp",
                                 str_detect(welfare_def, "Gross") ~ "gross",
                                 str_detect(welfare_def, "Consumption") ~ "con",
                                 TRUE ~ "market"),
            equiv_scale = equiv_scale,
            series = paste("CEPAL SDI", country, welfare_def, equiv_scale, survey),
            source1 = source,
            page = "",
            link = link)


# OECD Income Distribution Database (automated)
oecd_link <- "https://sdmx.oecd.org/public/rest/data/OECD.WISE.INE,DSD_WISE_IDD@DF_IDD,1.0/.A.INC_DISP_GINI+INC_DISP_SE+INC_MRKT_GINI+INC_GROSS_GINI..._T...?dimensionAtObservation=AllDimensions"

oecd0 <- oecd_link %>% 
  readSDMX() %>% 
  as_tibble() %>% 
  transmute(country = countrycode(REF_AREA, "iso3c", "swiid.name", custom_dict = cc_swiid),
            year = as.numeric(TIME_PERIOD),
            gini = obsValue,
            welfare_def = case_when(str_detect(MEASURE, "DISP") ~ "disp",
                                    str_detect(MEASURE, "MRKT") ~ "market",
                                    TRUE ~ "gross"),
            equiv_scale = "sqrt",   
            monetary = FALSE,
            series = paste("OECD", welfare_def, "sqrt,", tolower(DEFINITION), "def,", 
                           tolower(str_replace(METHODOLOGY, "METH", "")), "method"),
            source1 = "OECD",
            page = "", 
            link = oecd_link,
            measure = MEASURE)

oecd_se <- oecd0 %>% filter(measure=="INC_DISP_SE" & gini!=0) %>% 
  mutate(gini_se = if_else(gini < 0.1, gini, gini/100)) %>%   # data for Chile and China obv on wrong scale
  select(-gini, -measure)

oecd <- oecd0 %>% filter(measure!="INC_DISP_SE") %>% 
  left_join(oecd_se, by = c("country", "year", "equiv_scale", "welfare_def", "monetary", "series", "source1", "page", "link")) %>% 
  select(-measure)

rm(oecd0, oecd_se)         


# Eurostat (automated)
eurostat <- get_eurostat("ilc_di12", 
                         time_format = "num", 
                         update_cache = TRUE,
                         keepFlags = TRUE) %>%
  mutate(geo = as.character(geo) %>% recode("UK" = "GB", "EL" = "GR")) %>% 
  filter(!str_detect(geo, "E[AU]\\d*|NMS10") & str_detect(age, "TOTAL")) %>% 
  transmute(country = countrycode(as.character(geo), "iso2c", "swiid.name", custom_dict = cc_swiid),
            year = TIME_PERIOD - (!(country=="United Kingdom" | (country=="Ireland" & TIME_PERIOD < 2019))), #eurostat reports survey year not ref year except in UK and IE <https://ec.europa.eu/eurostat/cache/metadata/en/ilc_sieusilc.htm#ref_period1718211624296>
            gini = values/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",   
            monetary = TRUE,
            break_yr = ifelse(is.na(flags) | flags!="b", 0, 1),
            series = "",
            source1 = "Eurostat",
            page = "",
            link = "https://ec.europa.eu/eurostat/databrowser/view/tessi190/default/table?lang=en") %>% 
  filter(!(is.na(country) | is.na(gini))) %>% 
  group_by(country) %>% 
  arrange(country, year) %>% 
  mutate(series = paste("Eurostat", country, welfare_def, equiv_scale, cumsum(break_yr) + 1)) %>%  # No word from Eurostat which obs cross-nationally comparable
  ungroup() %>% 
  select(-break_yr)


# Transmonee 2012 (2012 is the last database that includes inequality data; archived)
transmonee_link <- "https://web.archive.org/web/20131030195756/http://www.transmonee.org/Downloads/EN/2012/TransMonEE_2012.xls"
tryCatch(download.file(transmonee_link, "data-raw/transmonee.xls"), 
         error = function(e) {
           download.file("https://github.com/fsolt/swiid/raw/master/data-raw/transmonee.xls", "data-raw/transmonee.xls")
         })

transmonee <- read_excel("data-raw/transmonee.xls", 
                         sheet = "10. Economy",
                         skip = 398,
                         na = "-",
                         col_names = c("country", "notes", 1989:2009))[1:34, ] %>% 
  filter(!is.na(country)) %>% 
  select(-notes) %>% 
  gather(key = year, value = gini, -country) %>% 
  filter(!is.na(gini)) %>% 
  transmute(country = countrycode(country, "country.name.en.regex", "swiid.name", custom_dict = cc_swiid),
            year = as.numeric(year),
            gini = gini,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("Transmonee", country, welfare_def, equiv_scale),
            source1 = "Transmonee 2012",
            page = "",
            link = transmonee_link)


# Commitment to Equity (update by hand; see http://www.commitmentoequity.org/publications-ceqworkingpapers/ and http://www.commitmentoequity.org/data/ )
ceq <- read_csv("data-raw/ceq.csv", col_types = "cnnncclcccc") %>% 
  mutate(series = if_else(is.na(series), paste("CEQ", welfare_def, equiv_scale), series))


# World Bank Africa Poverty Database (bespoke analysis of subset of WB surveys; archived)
afr_gini <- read_csv("https://raw.githubusercontent.com/fsolt/swiid/master/data-raw/AFR_gini_sqrt.csv", 
                     col_types = "cid") %>% 
  transmute(country = countrycode(country, origin = "wb_api3c", "swiid.name", custom_dict = cc_swiid),
            year = as.numeric(surveyr),
            gini = gini_sqrthhs/100,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "sqrt",
            monetary = FALSE,
            series = paste("World Bank Africa Poverty Database", country, welfare_def, equiv_scale),
            source1 = "Personal communication, K. Beegle, 2016-08-01",
            page = "",
            link = "https://raw.githubusercontent.com/fsolt/swiid/master/data-raw/AFR_gini_sqrt.csv")


# World Bank Poverty and Inequality Platform (automated--formerly Povcalnet)
wb <- pipr::get_stats(reporting_level = "national") %>% 
  transmute(country = countrycode(country_code, origin = "wb_api3c", "swiid.name", custom_dict = cc_swiid),
            year = round(as.numeric(year)),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = if_else(str_detect(welfare_type, "income"), "gross", "con"),
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("PIP", country, welfare_def, equiv_scale, survey_comparability + 1),
            source1 = "World Bank Poverty & Inequality Platform",
            page = "",
            link = "https://pip.worldbank.org/") %>% 
  filter(!is.na(gini))


## National Statistics Offices

first_row_to_names <- function(x) {
  names(x) <- as.character(x[1, ]) %>% 
    replace(.,
            is.na(.) | . == "",
            paste0("v", seq(length(which(is.na(.))) + length(which(. == "")))))
  x <- x[-1, ]
  return(x)
}

# National Statistical Service of Armenia (automated)
armstat_page <- "http://www.armstat.am/en/?nid=81&pthid=pov&year="
arm_page <- armstat_page %>% 
  read_html() %>% 
  html_nodes("h4 a")

get_access_link <- function(link) {
  access <- map(link, function(link) {
    t <- read_html(link) %>% 
      html_nodes("tr") 
    t2 <- t[str_detect(t %>% html_text(), "Accessibility|ACCESSIBILITY")] %>% 
      html_node("a") %>% 
      html_attr("href") %>% 
      str_replace("\\.\\.", "http://www.armstat.am") 
    return(t2)
  }) %>% 
    unlist()
  return(access)
}

arm_reports <- tibble(title = arm_page %>% html_text() %>% tolower(),
                      link1 = arm_page %>% html_attr("href")) %>% 
  filter(str_detect(title, "december") & !str_detect(title, "armenian")) %>% 
  mutate(link1 = str_replace(link1, "\\.", "http://www.armstat.am/en"),
         link2 = get_access_link(link1),
         year = str_extract(title, "\\d{4}"))

get_arm_ginis <- function(link) {
  file_yr <- str_extract(link, "\\d{2,4}") %>% 
    if_else(str_length(.) == 2, str_c("20", .), .)
  print(file_yr)
  file_name <- paste0("data-raw/armstat", file_yr, ".pdf")
  if (!file.exists(file_name)) download.file(link, file_name)
  ginis <- extract_tables(file_name, pages = 11)[[1]] %>% 
    as_tibble()
  if (!any(str_detect(ginis$`...1`, "Gini"))) {
    ginis <- extract_tables(file_name, pages = 12)[[1]]
  }
  ginis1 <- ginis %>% 
      fill(...1, .direction = "up") %>% 
      filter(str_detect(...1, "inequality")) %>% 
      gather(key = year, value = gini, -...1) %>% 
      filter(!is.na(gini)) %>% 
      mutate(report = as.numeric(file_yr),
             link = link)
  return(ginis1)
}

armstat <- arm_reports %>% 
  filter(year >= 2016) %>% 
  pull("link2") %>% 
  map_df(., ~ get_arm_ginis(.x)) %>% 
  arrange(desc(report), desc(year), ...1) %>% 
  distinct(year, ...1, .keep_all = TRUE) %>% 
  transmute(country = "Armenia",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = if_else(str_detect(...1, "consumption"), "con", "gross"),
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("NSS Armenia", welfare_def, equiv_scale),
            source1 = "National Statistical Service of Armenia",
            page = "95",
            link = link)

rm(arm_page, arm_reports)


# Australian Bureau of Statistics (update abs_link; not included in abs api as of 2019-02)
# confirm latest release at: http://www.abs.gov.au/AUSSTATS/abs@.nsf/second+level+view?ReadForm&prodno=6523.0&viewtitle=Household%20Income%20and%20Wealth,%20Australia~2013-14~Latest~04/09/2015&&tabname=Past%20Future%20Issues&prodno=6523.0&issue=2013-14&num=&view=&
# latest release link > downloads tab > copy link to download xls for "Household Income and Income Distribution, Australia, 1994–95 to [year]"

abs_link <- "https://www.abs.gov.au/statistics/economy/finance/household-income-and-wealth-australia/2019-20/1.%20Household%20income%20and%20income%20distribution%2C%20Australia.xlsx"
download.file(abs_link, "data-raw/abs.xlsx")

abs_format <- function(sheet, wd, es) {
  x <- read_excel("data-raw/abs.xlsx",
                  sheet = sheet,
                  skip = 4) %>%
    filter(str_detect(`...1`, "Gini")) %>%
    mutate(var = c("gini", "gini_se")) %>% 
    gather(year, value, -var) %>% 
    spread(var, value) %>% 
    filter(!str_detect(year, "\\.\\.\\.")) %>% 
    separate(year, into = c("year", "series"), sep = "\\(", fill = "right") %>% 
    transmute(country = "Australia",
              year = ifelse(str_extract(year, "\\d{2}$") %>% as.numeric() > 50,
                            str_extract(year, "\\d{2}$") %>% as.numeric() + 1900,
                            str_extract(year, "\\d{2}$") %>% as.numeric() + 2000),
              gini = as.numeric(gini),
              gini_se = as.numeric(gini_se)/100 * gini,
              welfare_def = wd,
              equiv_scale = es,
              monetary = FALSE,
              series = paste("ABS", welfare_def, equiv_scale,
                             as.numeric(factor(str_replace_na(series), levels = unique(str_replace_na(series))))),
              source1 = "Australian Bureau of Statistics",
              page = sheet,
              link = abs_link)
  return(x)
}

abs_de <- abs_format("Table 1.1", "disp", "oecdm")
abs_gh <- abs_format("Table 1.2", "gross", "hh")
abs <- bind_rows(abs_de, abs_gh)

rm(abs_de, abs_gh)


# Instituto Naciónal de Estadística de Bolivia (update file)
# https://www.ine.gob.bo/index.php/estadisticas-economicas/encuestas-de-hogares/
# > Pobreza y Desigualdad > BOLIVIA: ÍNDICE DE GINI PARA EL INGRESO PER CÁPITA MENSUAL, SEGÚN ÁREA, 2005 – 202x
inebo_link <- "https://nube.ine.gob.bo/index.php/s/48pjBmqdFIFxwfJ/download"
download.file(inebo_link, "data-raw/inebo.xlsx")
inebo <- read_excel("data-raw/inebo.xlsx", skip = 3) %>% 
  filter(INDICADOR=="Bolivia") %>% 
  select(-INDICADOR) %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Bolivia",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = gini,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("INE Bolivia", welfare_def, equiv_scale),
            source1 = "Instituto Naciónal de Estadística de Bolivia",
            page = "",
            link = inebo_link) %>% 
  filter(!is.na(gini))


# IPEA Brazil (1976-2014, archived)
ipea0 <- read_csv("data-raw/ipea0.csv", skip = 1) %>% 
    select(matches("\\d{4}")) %>% 
    gather(key = year, value = gini) %>% 
    transmute(country = "Brazil",
              year = as.numeric(year),
              gini = gini,
              gini_se = NA,
              welfare_def = "gross",
              equiv_scale = "pc",
              monetary = FALSE,
              series = paste("IPEA Brazil", welfare_def, equiv_scale, "1"),
              source1 = "Instituto de Pesquisa Económica Aplicada",
              page = "",
              link = "http://www.ipeadata.gov.br")

# IPEA Brazil (automated)
ipea <- ipeadata("PNADCA_GINIUF", language = "en") %>% 
    filter(uname=="Brazil") %>% 
    transmute(country = "Brazil",
            year = year(date),
            gini = value,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("IPEA Brazil", welfare_def, equiv_scale, "2"),
            source1 = "Instituto de Pesquisa Económica Aplicada",
            page = "",
            link = "http://www.ipeadata.gov.br") %>% 
    bind_rows(ipea0) %>% 
    arrange(country, year)

# Belarus National Statistical Committee (archived)
# select all years > export > xls
belstat_link <- "https://dataportal.belstat.gov.by/osids/indicator-info/10303000014"

belstat <- read_excel("data-raw/belstat.xls", skip = 1) %>%
  select(matches("^[12]")) %>% 
  pivot_longer(cols = matches("^[12]"),
               names_to = "year",
               values_to = "gini") %>% 
  transmute(country = "Belarus",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(str_replace(gini, ",", ".")),
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("Belstat", welfare_def, equiv_scale),
            source1 = "Belarus National Committee of Statistics",
            page = NA,
            link = belstat_link)

# Statistics Canada (automated)
tables <- c("11-10-0134-01", "11-10-0179-01", "11-10-0175-01")
eq_scales <- c("sqrt", "pc", "hh")

statcan <- map2(tables, eq_scales, ~ statcan_data(.x,"eng") %>% 
                    filter(GEO=="Canada") %>% 
                    mutate(equiv_scale = .y) %>%
                    mutate(link = paste0("https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=",
                                         str_remove(as.character(.x), "-")))) %>%
    list_rbind() %>% 
    filter(GEO=="Canada" & (`Economic family type`=="All family units" | is.na(`Economic family type`))) %>% 
    select(REF_DATE, VALUE, `Income concept`, equiv_scale, link) %>% 
    transmute(country = "Canada",
              year = year(REF_DATE),
              gini = VALUE,
              gini_se = gini*.02, # StatCan indicates CV < .02
              welfare_def = tolower(`Income concept`) %>% 
                  str_extract("market|after-tax|total") %>% 
                  str_replace("after-tax", "disp") %>% 
                  str_replace("total", "gross"),
              equiv_scale = equiv_scale,
              monetary = TRUE,
              series = paste("Statistics Canada", welfare_def, equiv_scale),
              source1 = "Statistics Canada",
              page = "",
              link) %>% 
    arrange(country, year, welfare_def, equiv_scale)


# DANE Colombia (update link)
# https://www.dane.gov.co/index.php/estadisticas-por-tema/pobreza-y-condiciones-de-vida/pobreza-monetaria >
# Anexo pobreza monetaria nacional > Descargar
dane0_link <- "https://www.dane.gov.co/files/investigaciones/condiciones_vida/pobreza/2021/anexo_pobreza_monetaria_21_nacional.xls"

dane0 <- read_excel("data-raw/dane.xls", sheet = "Gini", skip = 14) %>% 
    rename(region = 1) %>% 
    filter(region == "Nacional") %>% 
    gather(key = year, value = gini, -region) %>% 
    transmute(country = "Colombia",
              year = as.numeric(year),
              gini = gini,
              gini_se = NA,
              welfare_def = "gross",
              equiv_scale = "pc",
              monetary = FALSE,
              series = paste("DANE Colombia", welfare_def, equiv_scale, "1"),
              source1 = "Departamento Administrativo Nacional de Estadística Colombia",
              page = "",
              link = dane0_link)

dane_link <- "https://www.dane.gov.co/files/operaciones/PM/anex-PM-TotalNacional-2023.xlsx"
download.file(dane_link, "data-raw/dane.xlsx")

dane <- read_excel("data-raw/dane.xlsx", sheet = "Gini", skip = 14) %>% 
  rename(region = 1) %>% 
  filter(region == "Nacional") %>% 
  gather(key = year, value = gini, -region) %>% 
  transmute(country = "Colombia",
            year = as.numeric(year),
            gini = gini,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("DANE Colombia", welfare_def, equiv_scale, "2"),
            source1 = "Departamento Administrativo Nacional de Estadística Colombia",
            page = "",
            link = dane_link) %>% 
    bind_rows(dane0) %>% 
    arrange(country, year)


# Costa Rica (update link)
# https://inec.cr/es/tematicas/listado?filtertext=gini
# ENAHO. 202x. Coeficiente de Gini por hogar y per cápita, julio 2010 - 202x.
ineccr_link <- "https://admin.inec.cr/sites/default/files/2025-04/seingresosenaho2010-2024-01.xls"
  
download.file(ineccr_link, "data-raw/ineccr.xlsx")

ineccr <- read_excel("data-raw/ineccr.xlsx",
                     skip = 3,
                     sheet = "Cuadro 1") %>%
  select(Año, Total) %>% 
  filter(!is.na(Año)) %>% 
  mutate(es = if_else(cumsum(str_detect(Año, "por persona")) == 1, "pc", "hh")) %>% 
  filter(str_detect(Año, "^\\d{4}$")) %>% 
  transmute(country = "Costa Rica",
            year = as.numeric(Año),
            gini = Total,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = es,
            monetary = NA,
            series = paste("INEC", welfare_def, equiv_scale),
            source1 = "Instituto Naciónal de Estadística y Censos Costa Rica",
            page = "",
            link = ineccr_link)


# Statistics Denmark (automated)
dkstat <- dst_get_data(table = "IFOR41", 
                       ULLIG = "Gini coefficient", 
                       KOMMUNEDK = "All Denmark",
                       Tid = "*",
                       lang = "en") %>% 
  transmute(country = "Denmark",
            year = lubridate::year(TID),
            gini = value/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("Statistics Denmark", welfare_def, equiv_scale),
            source1 = "Statistics Denmark",
            page = "",
            link = "http://www.statbank.dk/IFOR41") 


# CAPMAS Egypt (archived)
capmas_link <- "https://web.archive.org/web/20180425181619/http://www.msrintranet.capmas.gov.eg/pdf/studies/inds/EG-LIV-E-I.xls" # this file isn't kept up to date anymore
download.file(capmas_link, "data-raw/capmas.xls") 

capmas <- read_excel("data-raw/capmas.xls", skip = 7) %>% 
  filter(Indicator == "Inequality of income or expenditure distribution (Gini coefficient), Total") %>% 
  select(contains("20")) %>% 
  gather(key = year, value = gini) %>% 
  filter(!is.na(gini)) %>% 
  transmute(country = "Egypt",
            year = as.numeric(year),
            gini = gini,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("CAPMAS", welfare_def, equiv_scale),
            source1 = "Central Agency for Public Mobilization and Statistics Egypt",
            page = "",
            link = capmas_link) 


# Statistics Estonia (automated)
statee_con_url <- "https://andmed.stat.ee/api/v1/en/stat/LE30"
statee_con <- pxweb_get(url = statee_con_url,
                        query = list("Aasta"=c("*"),
                                     "Tarbimiskaalud"=c("1","2","4"))) %>% 
  as.data.frame(column.name.type = "text", variable.value.type = "text") %>% 
  rename_with(~ tolower(str_replace(.x, "[\\s:].*", ""))) %>% 
  transmute(country = "Estonia",
            year = as.numeric(year),
            gini = as.numeric(le30),
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = case_when(str_detect(equivalence, "Estonian") ~ "ae",
                                    str_detect(equivalence, "OECD modified") ~ "oecdm",
                                    TRUE ~ "pc"),
            monetary = FALSE,
            series = paste("Statistics Estonia", welfare_def, equiv_scale),
            source1 = "Statistics Estonia",
            page = "",
            link = "https://andmed.stat.ee/api/v1/en/stat/LE30")

statee_url <- "https://andmed.stat.ee/api/v1/en/stat/LES25"
statee <- pxweb_get(url = statee_url,
                    query = list("Näitaja"=c("GINI"),
                                 "Vaatlusperiood"=c("*"),
                                 "Isikute rühm"=c("EST_NEST"))) %>% 
  as.data.frame(column.name.type = "text", variable.value.type = "text") %>% 
  rename_with(~ tolower(str_replace(.x, ":.*", ""))) %>% 
  filter(!is.na(les25)) %>% 
  transmute(country = "Estonia",
            year = as.numeric(`reference period`),
            gini = as.numeric(les25),
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "ae",
            monetary = FALSE,
            series = paste("Statistics Estonia", welfare_def, equiv_scale),
            source1 = "Statistics Estonia",
            page = "",
            link = statee_url) %>% 
  bind_rows(statee_con)

# Statistics Finland (automated)
statfi_link <- "https://statfin.stat.fi/PXWeb/api/v1/fi/StatFin_Passiivi/tjt/statfinpas_tjt_pxt_015_201700.px"
statfi <- pxweb_get_data(url = statfi_link,
                         pxweb_query(list(Tulokäsite = c("SL2","4L2","6L2"),
                                          Tiedot = c('Gini'),
                                          Vuosi = c('*')))) %>% 
  transmute(country = "Finland",
            year = as.numeric(as.character(Vuosi)),
            gini = `Gini-kertoimet ja muita tulonjakoindikaattoreita`/100,
            gini_se = NA,
            welfare_def = ifelse(str_detect(`Tulokäsite`, "Käytettävissä"), "disp",
                                 ifelse(str_detect(`Tulokäsite`, "Bruttotulot"), "gross",
                                        "market")),
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("Statistics Finland", welfare_def, equiv_scale),
            source1 = "Statistics Finland",
            page = "",
            link = "https://pxnet2.stat.fi/PXWeb/sq/7c6273ca-537e-418d-a63e-57dd4543d4ae")


# Insee France (archived; update link)
insee_link1 <- "https://web.archive.org/web/20151206151022/http://www.insee.fr/fr/themes/series-longues.asp?indicateur=gini-niveaux-vie"

insee1 <- readLines(insee_link1) %>%              # kickin' it old skool . . .
  str_subset("etendue-ligne|tab-chiffre") %>% 
  str_replace(".*>([\\d,]*)<.*", "\\1") %>% 
  str_replace(",", ".") %>% 
  matrix(ncol = 2, byrow = TRUE) %>% 
  as_tibble() %>% 
  transmute(year = as.numeric(V1),
            gini = as.numeric(V2)) %>%
  filter(!is.na(gini)) %>%
  transmute(country = "France",
            year = year,
            gini = gini,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("Insee", welfare_def, equiv_scale, 1),
            source1 = "Institut National de la Statistique et des Études Économiques France",
            page = "",
            link = insee_link1)

# https://www.insee.fr/fr/statistiques/7710966
insee_link2 <- "https://www.insee.fr/fr/statistiques/fichier/7710966/donnees_insee_premiere_n1973.xlsx"
download.file(insee_link2, here::here("data-raw", "insee2.xlsx"))

insee2 <- read_excel("data-raw/insee2.xlsx", sheet = "Tableau complémentaire 2", skip = 2) %>% 
  filter(str_detect(`Indicateur d'inégalités`, "Gini")) %>% 
  mutate(welfare_def = c("disp", "market")) %>% 
  pivot_longer(cols = matches("^[12]"),
               names_to = "year",
               values_to = "gini") %>% 
  filter(!is.na(gini)) %>%
  transmute(country = "France",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = gini,
            gini_se = NA,
            welfare_def = welfare_def,
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("Insee", welfare_def, equiv_scale, if_else(welfare_def == "disp", 2, 1)),
            source1 = "Institut National de la Statistique et des Études Économiques France",
            page = "Tableau complémentaire 2",
            link = insee_link2) %>% 
    filter(welfare_def == "market")

insee_link3 <- "https://www.insee.fr/fr/statistiques/fichier/2491918/reve-niv-vie-indic-inegalite.xlsx"
download.file(insee_link3, here::here("data-raw", "insee3.xlsx"))

insee3 <- read_excel("data-raw/insee3.xlsx", skip = 2) %>% 
    filter(str_detect(Indicateur, "Gini")) %>% 
    mutate(welfare_def = "disp") %>% 
    pivot_longer(cols = matches("^[12]"),
                 names_to = "year",
                 values_to = "gini") %>% 
    filter(!is.na(gini)) %>%
    mutate(series_no = str_split_i(year, "\\d{4}", -1),
           series_no = cumsum(series_no!="") + 1) %>% 
    mutate(series_no = if_else(is.na(series_no), 
                               2,
                               as.numeric(str_extract(series_no, "\\d$"))+2)) %>% 
    transmute(country = "France",
              year = as.numeric(str_extract(year, "\\d{4}")),
              gini = gini,
              gini_se = NA,
              welfare_def = welfare_def,
              equiv_scale = "oecdm",
              monetary = FALSE,
              series = paste("Insee", welfare_def, equiv_scale, series_no),
              source1 = "Institut National de la Statistique et des Études Économiques France",
              page = "",
              link = insee_link3)

insee <- bind_rows(insee1, insee2, insee3)

# Statistics Georgia (update link)
# https://pc-axis.geostat.ge/PXweb/pxweb/en/Database/Database__Social%20Statistics__Living%20Conditions,%20Subsistence%20Minimum/Gini_Coefficients.px/
geostat_link <- "https://pc-axis.geostat.ge:443/PXweb/sq/af8b0758-39dc-471c-bd90-ceecdaee1fd0"
download.file(geostat_link, "data-raw/geostat.csv")
geostat <- read_csv("data-raw/geostat.csv", skip = 2, col_types = "ccccccc") %>% 
  pivot_longer(!matches("Year"), names_to = "indicator", values_to = "gini_coefficients") %>% 
  transmute(country = "Georgia",
            year = as.numeric(Year),
            gini = as.numeric(gini_coefficients),
            gini_se = NA,
            welfare_def = case_when(indicator == "By total incomes" ~ "gross",
                                    indicator == "By total consumption expenditures" ~ "con",
                                    TRUE ~ NA_character_),
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("Geostat", welfare_def, equiv_scale),
            source1 = "Statistics Georgia",
            page = "",
            link = geostat_link) %>% 
  filter(!is.na(welfare_def))


# Statbank Greenland (automated)
greenland_link <- "https://bank.stat.gl:443/api/v1/en/Greenland/IN/IN40/INXIU101.px"
greenland <- pxweb_get_data(url = greenland_link,
                            pxweb_query(list(indicator = c('0'),
                                             time = c('*')))) %>%
  janitor::clean_names() %>% 
  transmute(country = "Greenland",
            year = as.numeric(time),
            gini = inequality_indicators_on_equivalised_disposable_income/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = NA,
            series = paste("Statbank Greenland", welfare_def, equiv_scale),
            source1 = "Statbank Greenland",
            page = "",
            link = greenland_link)


# Statistics Hong Kong (2021 census added to fs_added_data 6/2023; update with 2026 census when available)
hk2016_link <- "https://www.bycensus2016.gov.hk/data/16BC_Income_Report_Key_Statistics.xlsx"
hk2011_link <- "https://www.statistics.gov.hk/pub/B11200572012XXXXB0100.pdf"
hk2006_link <- "https://www.statistics.gov.hk/pub/B11200452006XXXXB0400.pdf"
# download.file(hk2016_link, "data-raw/hk2016.xlsx")
download.file(hk2011_link, "data-raw/hk2011.pdf")
download.file(hk2006_link, "data-raw/hk2006.pdf")

hk2016 <- read_excel("data-raw/hk2016.xlsx",
                     sheet = "KeyStat2", 
                     skip = 6,
                     col_types = c("skip", "guess", rep("skip", 4),
                                   rep("guess", 3), rep("skip", 5))) %>% 
  rename(incdef = 1) %>% 
  mutate(es = str_extract(incdef, ".* income")) %>% 
  fill(es) %>% 
  filter(str_detect(incdef, "\\([ac]\\)")) %>% 
  mutate(wd = if_else(incdef == "(a)", "market", "disp"),
         `2016` = str_replace(`2016`, "\\[", "")) %>% 
  select(`2006`, `2011`, `2016`, es, wd) %>% 
  gather(key = year, value = gini, -wd, -es) %>%
  transmute(country = "Hong Kong",
            year = as.numeric(year),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = wd,
            equiv_scale = if_else(str_detect(es, "per capita"), "pc", "hh"),
            monetary = FALSE,
            series = paste("Statistics Hong Kong", welfare_def, equiv_scale),
            source1 = "Statistics Hong Kong 2017",
            page = "KeyStat2",
            link = hk2016_link)

hk2011 <- extract_tables("data-raw/hk2011.pdf", pages = 123)[[1]] %>% 
rename(...2 = 2, ...3 = 3) %>% 
  mutate(wd = if_else(row_number() > 22,
                      "disp",
                      if_else(row_number() > 13, 
                              "posttax",
                              "market")),
         es = if_else(...1 == "合計堅尼系數", "hh", "pc")) %>% 
  filter(wd != "posttax" & str_detect(...2, "^\\d")) %>% 
  select(-...1, -...3) %>% 
  separate(...2, into = paste0("v", 1:3), sep = " ") %>% 
  first_row_to_names() %>%
  rename(wd = market, es = v1) %>% 
  gather(key = year, value = gini, -wd, -es) %>%
  filter(year == 2001) %>% 
  transmute(country = "Hong Kong",
            year = as.numeric(year),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = wd,
            equiv_scale = es,
            monetary = FALSE,
            series = paste("Statistics Hong Kong", welfare_def, equiv_scale),
            source1 = "Statistics Hong Kong 2012",
            page = "107",
            link = hk2011_link)

hk2006 <- extract_tables("data-raw/hk2006.pdf", pages = 105)[[1]] %>% 
    filter(row_number() > 10) %>% 
    rename(...1 = 1, ...2 = 2) %>% 
    mutate(wd = if_else(row_number() > 20,
                        "disp",
                        if_else(row_number() > 12, 
                                "posttax",
                                "market")),
           es = if_else(...1 == "合計堅尼系數", "hh", "pc")) %>% 
  filter(wd != "posttax" & str_detect(...2, "^\\d")) %>% 
  select(-...1) %>% 
  separate(...2, into = paste0("v", 1:3), sep = " ") %>% 
  first_row_to_names() %>%
  rename(wd = market, es = v1) %>% 
  gather(key = year, value = gini, -wd, -es) %>%
  filter(year == 1996) %>% 
  transmute(country = "Hong Kong",
            year = as.numeric(year),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = wd,
            equiv_scale = es,
            monetary = FALSE,
            series = paste("Statistics Hong Kong", welfare_def, equiv_scale),
            source1 = "Statistics Hong Kong 2007",
            page = "107",
            link = hk2006_link)

stathk <- bind_rows(hk2006, hk2011, hk2016)

rm(hk2006, hk2011, hk2016)


# BPS Indonesia (automated; update bpsid2 file)
# https://www.bps.go.id/statictable/2014/09/08/946/distribusi-pembagian-pengeluaran-per-kapita-dan-indeks-gini-2010-2017.html > Download Table

bpsid1_link <- "https://web.archive.org/web/20150405134743/https://www.bps.go.id/website/tabelExcelIndo/indo_23_6.xls"
download.file(bpsid1_link, "data-raw/bpsid1.xls")
bpsid2_link <- "https://www.bps.go.id/id/statistics-table/1/OTQ2IzE=/distribusi-pembagian-pengeluaran-per-kapita-dan-indeks-gini-2010-2017.html"

bpsid1 <- read_excel("data-raw/bpsid1.xls", skip = 2) %>% 
  filter(Provinsi == "INDONESIA") %>% 
  select(-Provinsi) %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Indonesia",
            year = as.numeric(year),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("Statistics Indonesia", welfare_def, equiv_scale),
            source1 = "Statistics Indonesia",
            page = "",
            link = bpsid1_link)

bpsid2 <- read_excel("data-raw/bpsid2.xls", skip = 2) %>% 
  janitor::clean_names() %>% 
  fill(area) %>% 
  filter(area == "Urban + Rural" & !is.na(year_month)) %>% 
  rename(year = year_month, gini = `gini_index`) %>% 
  transmute(country = "Indonesia",
            year = year,
            gini = gini,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("Statistics Indonesia", welfare_def, equiv_scale),
            source1 = "Statistics Indonesia",
            page = "",
            link = bpsid2_link) 

bpsid <- bind_rows(bpsid1, bpsid2) %>% 
  arrange(year, link) %>% 
  distinct(year, .keep_all = TRUE)

rm(bpsid1, bpsid2)


# Statistical Center of Iran (update link--search site with Google; blocked as of 12-08-2018, so use archive.org version)
# https://www.google.com/search?hl=en&as_q=gini&as_sitesearch=https%3A%2F%2Fwww.amar.org.ir
# Still blocked 12/2023
# Not blocked 8/2024, but no updated file--added 2018 and 2019 Ginis from home page to fs_added_data.csv

amar_link <- "https://web.archive.org/web/20191116072717/https://www.amar.org.ir/Portals/1/releases/heis/total/Gini%20coefficient%20of%20the%20years%201380-1396.xlsx?ver=2019-04-09-101341-147"
download.file(amar_link, "data-raw/amar.xlsx")
amar <- read_excel("data-raw/amar.xlsx", skip = 2) %>% 
  filter(...1 == "Gini coefficient") %>% 
  select(-...1) %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Iran",
            year = as.numeric(year) + 621,
            gini = gini,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("Statistical Center of Iran", welfare_def, equiv_scale),
            source1 = "Statistical Center of Iran",
            page = "",
            link = amar_link)


# CSO Ireland (automated)
cso_ie <- cso_get_data("SIA47", pivot_format = "tall", use_factors = FALSE, cache = FALSE) %>% 
  filter(str_detect(Statistic, "Gini")) %>% 
  transmute(country = "Ireland",
            year = as.numeric(as.character(Year)),
            gini = as.numeric(value)/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "ae",
            monetary = FALSE,
            series = paste("CSO Ireland", welfare_def, equiv_scale),
            source1 = "CSO Ireland",
            page = "",
            link = "https://data.cso.ie/table/SIA47")


# Istat (archived; automated)
istat1 <- read_csv("https://raw.githubusercontent.com/fsolt/swiid/master/data-raw/istat.csv",
                  col_types = "ccccicdc") %>% 
  transmute(country = "Italy",
            year = Year,
            gini = `0`,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "hh",
            monetary = FALSE,
            series = paste("Istat", welfare_def, equiv_scale, "1"),
            source1 = "Istat",
            page = "",
            link = "http://dati.istat.it/Index.aspx?DataSetCode=DCCV_INDCONSUMI&Lang=en")

istat2_link <- "https://esploradati.istat.it/SDMXWS/rest/data/IT1,31_740_DF_DCCV_SPEMEFAM_COICOP_2018_11,1.0/A.IT........./ALL/?detail=full&dimensionAtObservation=TIME_PERIOD"

istat2 <- rsdmx::readSDMX(istat2_link) %>%
  as_tibble() %>% 
  filter(DATA_TYPE == "DISUG_CONSUMI_GINI") %>% 
  transmute(country = "Italy",
            year = as.integer(obsTime),
            gini = obsValue,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "hh",
            monetary = FALSE,
            series = paste("Istat", welfare_def, equiv_scale, "2"),
            source1 = "Istat",
            page = "",
            link = istat2_link)

istat <- bind_rows(istat1, istat2)
rm(istat1, istat2)

# Statinja (update file)
# http://statinja.gov.jm/living_conditions_poverty.aspx
# Incidence of Poverty > Gini Coefficient, Jamaica > Download > unclick "Dates Across Top" > csv

statinja <- read_csv("data-raw/statinja.csv",
                     skip = 14,
                     col_names = c("date", "old", "new"),
                     col_types = "cdd") %>% 
  pivot_longer(cols = old:new,
               names_to = "series",
               values_to = "gini") %>% 
  filter(!is.na(gini)) %>% 
  transmute(country = "Jamaica",
            year = as.numeric(str_extract(date, "\\d{4}")),
            gini = gini,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            series = paste("Statinja", welfare_def, equiv_scale, if_else(series=="old", 1, 2)),
            source1 = "Statistical Institute of Jamaica",
            page = "",
            link = "http://statinja.gov.jm/living_conditions_poverty.aspx")


# Kazakhstan Committee on Statistics (update link; check https://kazstat.github.io/sdg-site-kazstat/en/10-4-2/ also)
kazstat_page <- "https://stat.gov.kz/upload/iblock/148/wd6nm1mzguzll31r3k1zt2r1n3p9vpwi/Indicators_of_poverty_and_inequality_by_region.xlsx"

download.file(kazstat_page, "data-raw/kazstat.xlsx")

kazstat <- read_excel("data-raw/kazstat.xlsx",
                      sheet = "Gini",
                      skip = 3,
                      .name_repair = ~ make.names(.x, unique = TRUE)) %>%
  rename(region = 1) %>% 
  filter(region == "Republic of Kazakhstan") %>% 
  select(-region, -ends_with(".1")) %>% 
  gather(key = year, value = gini) %>% 
  filter(gini < 1) %>% # because 2017 ratio without 2017 gini on 2019-02-08 
  transmute(country = "Kazakhstan",
            year = as.numeric(str_replace(year, "X", "")),
            gini = as.numeric(gini) %>% round(3),
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("Kazstat", welfare_def, equiv_scale),
            source1 = "Kazakhstan Committee on Statistics",
            page = "",
            link = kazstat_page)


# Statistics Korea (update kostat2 file)
# https://kosis.kr/statHtml/statHtml.do?orgId=101&tblId=DT_1L6E001&conn_path=I2&language=en
kostat2_link <- "https://kosis.kr/statHtml/statHtml.do?orgId=101&tblId=DT_1HDLF05&conn_path=I2&language=en"

kostat1 <- read_csv("data-raw/kostat1.csv",
                   col_types = cols(
                     .default = col_double(),
                     Item = col_character(),
                     `By income` = col_character()
                   )) %>%
  filter(!is.na(`Gini's coefficient`)) %>% 
  transmute(country = "Korea",
            year = as.numeric(Period),
            gini = `Gini's coefficient`,
            gini_se = NA,
            welfare_def = if_else(str_detect(`By income`, "Disposable"), "disp", "market"),
            equiv_scale = "ae",
            monetary = NA,
            series = paste("Kostat", welfare_def, equiv_scale, if_else(Item == "All households", "national", "urban"), "1"),
            source1 = "Statistics Korea",
            page = "",
            link = "http://kosis.kr/statHtml/statHtml.do?orgId=101&tblId=DT_1L6E001&conn_path=I2&language=en")

kostat2 <- read_csv("data-raw/kostat2.csv",
                    col_types = "dcd") %>%
  janitor::clean_names() %>% 
  transmute(country = "Korea",
            year = as.numeric(period),
            gini = gini_coefficient,
            gini_se = NA,
            welfare_def = if_else(str_detect(item, "Disposable"), "disp", "market"),
            equiv_scale = "ae",
            monetary = NA,
            series = paste("Kostat", welfare_def, equiv_scale, "national 2"),
            source1 = "Statistics Korea",
            page = "",
            link = kostat2_link)

kostat <- bind_rows(kostat1, kostat2)

# National Statistical Committee of Kyrgyzstan (automated)
nsck_link <- "http://www.stat.kg/en/statistics/download/dynamic/543/"
download.file(nsck_link, "data-raw/nsck.xls")

nsck <- read_excel("data-raw/nsck.xls") %>% 
  filter(str_detect(`5.04.00.14 Additional tables- incomes`, "Items|Gini")) %>% 
  first_row_to_names() %>% 
  select(matches("\\d{4}")) %>% 
  gather(key = year, value = gini) %>% 
  filter(!is.na(gini)) %>% 
  transmute(country = "Kyrgyzstan",
            year = as.numeric(year),
            gini = gini,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = TRUE,
            series = paste("NSC Kyrgyzstan", welfare_def, equiv_scale),
            source1 = "National Statistical Committee of Kyrgyzstan",
            page = "5.04.00.14",
            link = nsck_link)


# Economy Planning Unit of Malaysia (automated)
epumy_link <- "https://www.ekonomi.gov.my/en/socio-economic-statistics/household-income-poverty-and-household-expenditure" %>% 
  read_html() %>%
  html_node(xpath="//a[contains(@href, 'Gini')]") %>% 
  html_attr("href") %>% 
  str_c("https://www.ekonomi.gov.my", .)

download.file(epumy_link, "data-raw/epumy.pdf")

epumy <- extract_tables("data-raw/epumy.pdf") %>% 
    first() %>% 
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column() %>% 
    transmute(country = "Malaysia",
              year = as.numeric(str_extract(rowname, "\\d{4}")),
              gini = as.numeric(V1),
              gini_se = NA,
              welfare_def = "gross",
              equiv_scale = "hh",
              monetary = FALSE,
              series = paste("EPU Malaysia", welfare_def, equiv_scale),
              source1 = "Economy Planning Unit of Malaysia",
              page = "1",
              link = epumy_link) %>% 
    filter(!is.na(gini))


# National Bureau of Statistics Moldova (archived; automated)
nbs0_link <- "https://github.com/fsolt/swiid/raw/master/data-raw/nbs0.xls"
download.file(nbs0_link, "data-raw/nbs0.xls")

nbs0 <- read_excel("data-raw/nbs0.xls", skip = 2, sheet = "Лист1") %>%
  first_row_to_names() %>% 
  filter(str_detect(v1, "coeficientul Gini")) %>% 
  select(-v1) %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Moldova",
            year = as.numeric(year),
            gini = gini,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("NBS Moldova", welfare_def, equiv_scale, 1),
            source1 = "National Bureau of Statistics of Moldova",
            page = "112",
            link = "https://statistica.gov.md/public/files/publicatii_electronice/Anuar_Statistic/2017/Anuar_statistic_2017.pdf")

nbs1_link <- "https://statbank.statistica.md/pxweb/api/v1/en/30%20Statistica%20sociala/04%20NIV/NIV070/NIV071200.px"
nbs1 <- pxweb_get_data(url = nbs1_link,
                         query = list("Medii"=c("0"),
                                      "Indicatori"=c("0","2"),
                                      "Ani"=c("*"))) %>% 
  janitor::clean_names() %>% 
  transmute(country = "Moldova",
            year = as.numeric(years),
            gini = inequality_measures,
            gini_se = NA,
            welfare_def = if_else(str_detect(indicators, "disp"), "disp", "con"),
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("NBS Moldova", welfare_def, equiv_scale, 2),
            source1 = "National Bureau of Statistics of Moldova",
            page = "",
            link = nbs1_link)

nbs <- bind_rows(nbs0, nbs1)

# Statistics Office of Montenegro (automated, but update backup Internet Archive link)
# Slow server, so get from Internet Archive if it times out
get_monstat_file <- function() {
  monstat_file <- session("https://www.monstat.org/eng/index.php") %>% 
    session_follow_link("Household consumption") %>% 
    session_follow_link("Absolute poverty line") %>% 
    session_follow_link("Data")
  writeBin(httr::content(monstat_file$response, "raw"), "data-raw/monstat.xls")
  return(monstat_file$response$url)
}

monstat_link <- tryCatch(get_monstat_file(), 
                         error = function(e) {
                           monstat_file <- session("https://web.archive.org/web/20210421010924/https://www.monstat.org/eng/index.php") %>% 
                             session_follow_link("Household consumption") %>% 
                             session_follow_link("poverty line") %>% 
                             session_follow_link("Data")
                           writeBin(httr::content(monstat_file$response, "raw"), "data-raw/monstat.xls")
                           return(monstat_file$response$url)
                         })

monstat <- read_excel("data-raw/monstat.xls", skip = 1) %>%
  rename(year = 1) %>% 
  filter(!is.na(`Gini coefficient (%)`)) %>% 
  transmute(country = "Montenegro",
            year = as.numeric(year),
            gini = `Gini coefficient (%)`/100,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "oecdm",
            monetary = NA,
            series = paste("Monstat", welfare_def, equiv_scale),
            source1 = "Statistical Office of Montenegro",
            page = "",
            link = monstat_link)


# Statistics New Zealand (archived)
snz_link <- "https://web.archive.org/web/20170407020304/http://www2.stats.govt.nz/domino/external/pasfull/pasfull.nsf/84bf91b1a7b5d7204c256809000460a4/4c2567ef00247c6acc256b03000bdbe0/$FILE/Income.xls"
download.file(snz_link, "data-raw/snz.xls")

snz <- read_excel("data-raw/snz.xls",
                  sheet = "A2.2", skip = 3) %>% 
  transmute(country = "New Zealand",
            year = as.numeric(Year),
            gini = `Gini coefficient`,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm", # actually the Revised Jensen Scale, but basically identical to oecdm (see https://www.msd.govt.nz/documents/about-msd-and-our-work/publications-resources/monitoring/household-income-report/2014/appendices.doc)
            monetary = NA,
            series = paste("Statistics New Zealand 1999", welfare_def, equiv_scale),
            source1 = "Statistics New Zealand 1999",
            page = "100",
            link = "https://web.archive.org/web/20170407020304/http://www2.stats.govt.nz/domino/external/pasfull/pasfull.nsf/84bf91b1a7b5d7204c256809000460a4/4c2567ef00247c6acc256b03000bdbe0/$FILE/Incomes.pdf")


# New Zealand Ministry of Social Development
# update link from http://www.msd.govt.nz/about-msd-and-our-work/publications-resources/monitoring/household-incomes/index.html
# (if a .doc file, install LibreOffice, follow instructions at https://ask.libreoffice.org/en/question/12084/how-to-convert-documents-to-pdf-on-osx/?answer=50029#post-id-50029 (copy the script bc the link is dead), and convert via command line)
# update wrangle (including publication year)
nzmsd_link <- "https://www.msd.govt.nz/documents/about-msd-and-our-work/publications-resources/monitoring/household-income-report/2019/household-incomes-report-2019.doc"
download.file(nzmsd_link, "data-raw/nzmsd.doc")
system('soffice --headless --convert-to pdf:"writer_pdf_Export" --outdir ./data-raw data-raw/nzmsd.doc')

nzmsd <- extract_tables("data-raw/nzmsd.pdf", pages = 105) %>% 
  first() %>% 
  as_tibble() %>% 
  filter(str_detect(...1, "\\d{4}")) %>% 
  transmute(country = "New Zealand",
            year = as.numeric(...1),
            gini = as.numeric(str_extract(`Gini coefficient`, "\\d\\d\\.\\d"))/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "sqrt",
            monetary = NA,
            series = paste("Perry 2019", welfare_def, equiv_scale),
            source1 = "Perry 2019",
            page = "95",
            link = nzmsd_link) %>% 
  filter(!is.na(gini))


# Statistics Norway (automated)
ssb <- pxweb_get_data(url = "https://data.ssb.no/api/v0/en/table/07756/",
                      pxweb_query(list(Forbruksenhet2 = c('01'),
                                       ContentsCode = c('Ginikoeffisient', 'StandardavvikGini'),
                                       Tid = c('*')))) %>% 
  transmute(country = "Norway",
            year = as.numeric(as.character(year)),
            gini = `Gini coefficient`,
            gini_se = `Standard error of the Gini coefficient`,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = TRUE,
            series = paste("SSB", welfare_def, equiv_scale),
            source1 = "Statistics Norway",
            page = "",
            link = "https://www.ssb.no/en/statbank/table/07756/")


# DGEEC Paraguay (archived; update fs_data_added)
# https://www.ine.gov.py > ESTÁDISTICA POR TEMA > Ingresos
dgeec_link <- "https://web.archive.org/web/20230420113835/https://www.ine.gov.py/assets/documento/84ccaIngresos_indicadores%20de%20desigualdad_py_EPH%201997-98_2021.xls"

download.file(dgeec_link, "data-raw/dgeec.xls")

dgeec <- read_excel("data-raw/dgeec.xls", skip = 3) %>% 
  janitor::clean_names() %>% 
  filter(!is.na(x1) & !is.na(coeficiente_de_gini_2)) %>%
  transmute(country = "Paraguay",
            year = str_trim(x1) %>% 
              str_extract("\\d{4}/?\\d{0,2}") %>% 
              str_replace("(\\d{2})\\d{2}/(\\d{2})", "\\1\\2") %>% 
              as.numeric(),
            gini = coeficiente_de_gini_2,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = TRUE,
            series = paste("DGEEC", welfare_def, equiv_scale),
            source1 = "Dirección General de Estadística, Encuestas y Censos",
            page = "",
            link = dgeec_link) %>% 
  filter(!is.na(gini))


# Philippines Statistical Agency (update)
psa_link <- "https://psa.gov.ph/system/files/iesd/Table%205.%202018%2C%202021%20and%202023p%20Gini%20Coefficient%20and%20Palma%20Ratio%2C%20by%20Region%2C%20Province%20and%20HUC.xlsx"
# download.file(psa_link, "data-raw/psa.xlsx")

psa <- read_excel("data-raw/psa.xlsx", skip = 1) %>% 
  clean_names() %>% 
  select(region_province_huc, matches("\\d{4}")) %>% 
  filter(region_province_huc == "PHILIPPINES") %>%
  gather(key = year, value = gini, -region_province_huc) %>% 
  transmute(country = "Philippines",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("PSA", welfare_def, equiv_scale),
            source1 = "Philippines Statistical Agency",
            page = "",
            link = psa_link)


# Russian Federal State Statistics Service (update link: https://eng.rosstat.gov.ru/Publications/document/74811)
# https://rosstat.gov.ru/publications-plans > look for \\d{4} of last year and 'Российский статистический ежегодник (на русском и английском языках) [Russian Statistical Yearbook (in Russian and English)]'
# https://rosstat.gov.ru/folder/210/document/12994 > first link should be 'ПРИЛОЖЕНИЕ к Ежегоднику [Yearbook Supplement]'
# https://rosstat.gov.ru/folder/210/document/13396 > find xls

rosstat1_link <- "https://rosstat.gov.ru/storage/mediabank/pril-year_2021.rar"
# download.file(rosstat1_link, "data-raw/rosstat1.rar")
# untar("data-raw/rosstat1.rar",
#       exdir = "data-raw/rosstat")

rosstat1 <- read_excel("data-raw/rosstat/Ретро_2021_Раздел5.xls", skip = 2) %>% 
  filter(str_detect(ПОКАЗАТЕЛИ, "Джини")) %>% 
  gather(key = year, value = gini) %>% 
  filter(str_detect(year, "\\d{4}")) %>% 
  mutate_all(as.numeric) %>% 
  transmute(country = "Russian Federation",
            year = year,
            gini = gini,
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = TRUE,
            series = paste("Rosstat", welfare_def, equiv_scale),
            source1 = "Russian Federal State Statistics Service",
            page = "Ретро_2021_Раздел5.xls",
            link = rosstat1_link)

rosstat2_link <- "https://eng.rosstat.gov.ru/storage/mediabank/Year%202023.rar"
# download.file(rosstat2_link, "data-raw/rosstat2.rar")
# untar("data-raw/rosstat2.rar",
#       files = "R_06.docx",
#       exdir = "data-raw/rosstat")

rosstat2 <- read_docx("data-raw/rosstat/R_06.docx") %>% 
    docx_extract_tbl(19) %>% 
    janitor::clean_names() %>% 
    filter(str_detect(x_2, "Gini")) %>% 
    gather(key = year, value = gini) %>% 
    filter(str_detect(year, "\\d{4}")) %>% 
    mutate(year = str_extract(year, "\\d{4}"),
           gini = str_replace(gini, ",", ".")) %>% 
    mutate(across(everything(), as.numeric)) %>% 
    transmute(country = "Russian Federation",
              year = year,
              gini = gini,
              gini_se = NA,
              welfare_def = "gross",
              equiv_scale = "pc",
              monetary = TRUE,
              series = paste("Rosstat", welfare_def, equiv_scale),
              source1 = "Russian Federal State Statistics Service",
              page = "168",
              link = rosstat2_link)

rosstat <- bind_rows(rosstat1, 
                     anti_join(rosstat2,
                               rosstat1,
                               by = c("year", "gini"))) %>% 
  arrange(country, year)

rm(rosstat1, rosstat2)

# Singapore Department of Statistics (automatic)
# Note: Population covered is only resident households with at least one worker 
#  and so excludes 8-11% of resident households (which, from other data, appear
#  to be among the poorest), plus all non-resident households (surely poor).
# Note also that income definition excludes income from capital.
# These data therefore should be considered a lower bound.  Blech.

singstat_url <- "https://tablebuilder.singstat.gov.sg/api/table/tabledata/M810361"

singstat <- jsonlite::fromJSON(singstat_url) %>% 
    pluck("Data") %>%
    pluck("row") %>% 
    as_tibble() %>% 
    unnest(columns) %>%
    filter(str_detect(rowText, "Gini")) %>% 
    transmute(country = "Singapore",
              year = as.numeric(key),
              gini = as.numeric(value),
              gini_se = NA,
              welfare_def = if_else(str_detect(rowText, "After"), "disp", "market"),
              equiv_scale = case_when(str_detect(rowText, "OECD") ~ "oecdm",
                                      str_detect(rowText, "Square") ~ "sqrt",
                                      TRUE ~ "pc"),
              monetary = TRUE,
            series = paste("Singstat", welfare_def, equiv_scale),
            source1 = "Singapore Department of Statistics",
            page = "",
            link = singstat_url)


# Statistics Slovenia (automated)
ssi1_link <- "https://www.stat.si/doc/vsebina/08/kazalniki_soc_povezanosti_Laekens_97_03.xls"
download.file(ssi1_link, "data-raw/ssi.xls", method = "curl", extra = "-k")

ssi1 <- read_excel("data-raw/ssi.xls",
                   sheet = "Laekens kazalniki 1997-2003",
                   skip = 4,
                   .name_repair = ~ make.names(.x, unique = TRUE)) %>% 
  filter(str_detect(X, "Gini")) %>% 
  select(-X, -X.1, -X.2, -X.3) %>% 
  gather(key = year0, value = gini) %>% 
  transmute(country = "Slovenia",
            year = as.numeric(str_extract(year0, "\\d{4}")),
            gini = as.numeric(gini)/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = !str_detect(year0, "\\.1"),
            series = paste("Statsi 2005", welfare_def, equiv_scale, as.numeric(as.factor(monetary))),
            source1 = "Slovenia Statistics Office 2005",
            page = "Laekens kazalniki 1997-2003",
            link = ssi1_link) 

# (automated)
ssi2_link <- "https://pxweb.stat.si:443/SiStatData/sq/279"
download.file(ssi2_link, "data-raw/ssi2.px")

ssi2 <- pxR::read.px("data-raw/ssi2.px") %>% 
  pxR:::as.data.frame.px() %>% 
  transmute(country = "Slovenia",
            year = as.numeric(as.character(LETO)) - 1,
            gini = as.numeric(value)/100,
            gini_se = NA,
            welfare_def = "market",
            equiv_scale = "oecdm",
            monetary = TRUE,
            series = paste("Statsi", welfare_def, equiv_scale),
            source1 = "Slovenia Statistics Office",
            page = "",
            link = ssi2_link)

ssi <- bind_rows(ssi1, ssi2)
rm(ssi1, ssi2)


# Instituto Nacional de Estadística Spain (update link?)
ine_link <- "https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/49149.csv"
# download.file(ine_link, "data-raw/ine.csv")

ine <- read_csv2("data-raw/ine.csv",
                 col_types = "cdd") %>% 
  filter(str_detect(`Coeficiente de Gini`, "con alquiler imputado")) %>% 
  transmute(country = "Spain",
            year = Periodo - 1,
            gini = Total/100,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("Instituto Nacional de Estadistica Spain", welfare_def, equiv_scale),
            source1 = "Instituto Nacional de Estadística Spain",
            page = "",
            link = ine_link)


# Statistics Sri Lanka (archived)
statslk_link <- "https://web.archive.org/web/20200215071622/http://www.statistics.gov.lk/HIES/HIES2012_13FinalReport.pdf"
statslk_link1 <- "https://github.com/fsolt/swiid/raw/master/data-raw/statslk2015.pdf"
download.file(statslk_link1, "data-raw/statslk2015.pdf")

statslk <- extract_tables("data-raw/statslk2015.pdf", pages = 22)[[1]] %>%
  as_tibble() %>% 
  filter(str_detect(Variable, "Gini coefficient of household") | is.na(Variable)) %>% 
  separate(`Survey period`, into = c("v7", "v7a"), sep = " ") %>% 
  first_row_to_names() %>% 
  filter(is.na(v2)) %>% 
  select(-v2) %>% 
  gather(key = year, value = gini, -v1) %>% 
  filter(!gini == "-") %>% 
  transmute(country = "Sri Lanka",
            year = as.numeric(str_replace(year, "^(\\d{2}).*(\\d{2})$", "\\1\\2")),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = if_else(str_detect(v1, "income"), "gross", "con"),
            equiv_scale = "hh",
            monetary = NA,
            series = paste("Statistics Sri Lanka", welfare_def, equiv_scale),
            source1 = "Statistics Sri Lanka 2015",
            page = "x",
            link = statslk_link)


# Statistics Sweden (automated)
scb_link <- "https://api.scb.se/OV0104/v1/doris/sv/ssd/HE/HE0110/HE0110F/TabVX1DispInkN"

scb <- pxweb_get_data(url = scb_link,
                      pxweb_query(list(Region = c('00'),
                                  InkomstTyp = c("FastInkIn","DispInkInkl"),
                                  ContentsCode = c("000006PO"),
                                  Tid = c('*')))) %>%
  transmute(country = "Sweden",
            year = as.numeric(as.character(år)),
            gini = `Gini-koefficient`,
            gini_se = NA,
            welfare_def = ifelse(str_detect(inkomstslag, "disponibel"), "disp",
                                 "market"),
            equiv_scale = "ae",
            monetary = FALSE,
            series = paste("Statistics Sweden", welfare_def, equiv_scale, ifelse(year<1991, 1, 2)),
            source1 = "Statistics Sweden",
            page = "",
            link = scb_link)


# Federal Statistics Office, Switzerland (update file)
# "https://www.bfs.admin.ch/bfs/en/home/statistics.html" >
# Economic and social situation >
# Social situation, well-being, and poverty >
# Inequality of income distribution >
# Redistribution of income >
# Trends in Gini: Details and download >
# Download icon: 'Get the data'

fso_ch_link <- "https://www.bfs.admin.ch/bfs/en/home/statistics/economic-social-situation-population/economic-and-social-situation-of-the-population.assetdetail.33414023.html"
fso_ch0 <- read_csv("data-raw/fso_ch.csv") %>% 
  filter(!is.na(`primary equivalised income`)) %>%
    mutate(across(everything(), ~ as.numeric(str_replace(.x, ",", ".")))) %>% 
  transmute(year = Jahr,
            market = `primary equivalised income`,
            market_se = (`VI+` - `VI-`)/1.96,
            gross = `gross equivalised income`,
            gross_se = (`VI+1` - `VI-1`)/1.96,
            disp = `disposable equivalised income`,
            disp_se = (`VI+2` - `VI-2`)/1.96) %>% 
  gather(key = "welfare_def", value = "gini", -year)

fso_ch <- fso_ch0 %>% 
  filter(!str_detect(welfare_def, "_se")) %>%
  left_join(fso_ch0 %>% 
              filter(str_detect(welfare_def, "_se")) %>% 
              transmute(year = year,
                        welfare_def = str_replace(welfare_def, "_se", ""),
                        gini_se = gini), 
            by = c("year", "welfare_def")) %>% 
  transmute(country = "Switzerland",
            year = year,
            gini = gini,
            gini_se = gini_se,
            welfare_def = welfare_def,
            equiv_scale = "oecdm",
            monetary = TRUE,
            series = paste("FSO", welfare_def, equiv_scale),
            source1 = "Switzerland Federal Statistics Office",
            page = "",
            link = fso_ch_link) 

rm(fso_ch0)

# Taiwan Directorate General of Budget, Accounting, and Statistics 
# update tdfbas_link:
# https://eng.stat.gov.tw/News.aspx?n=4218&sms=11711 >
# Report on the Survey of Family Income and Expenditure, 202[3]
# 5.Per capita disposable income inequality indices [EXCEL]
tdgbas_link <- "https://ws.dgbas.gov.tw/001/Upload/463/relfile/11530/233680/Year05.xls"
# update tdfbas_link2:
# https://eng.stat.gov.tw/cl.aspx?n=4004 (Data Query)
# 09. National Economics and Business Activities
# Average disposable income per household by disposable income quintile
tdgbas_link2 <- "https://ws.dgbas.gov.tw/001/Upload/464/relfile/10924/232171/y046.xls"
# archived
tdgbas_link3 <- "https://web.archive.org/web/20220628200708/http://statdb.dgbas.gov.tw/pxweb/Dialog/varval.asp?ma=FF0004A1A&ti=Percentage%20Share%20of%20Disposable%20Income%20by%20Percentile%20Group%20of%20Households%20and%20Income%20Inequality%20Indexes-Annual&path=../PXfileE/HouseholdFinances/&lang=1&strList=L#expand"

tdgbas <- read_excel("data-raw/tdgbas1.xls", col_names = FALSE, skip = 9, 
                     .name_repair = ~ make.names(.x, unique = TRUE)) %>% 
  transmute(year = X.1,
            pc = X.3,
            sqrt = X.5) %>% 
  gather(key = equiv_scale, value = gini, -year) %>% 
  filter(!is.na(year)) %>% 
  mutate(link = tdgbas_link) %>% 
  bind_rows(read_excel("data-raw/tdgbas2.xls", skip = 8, 
                       .name_repair = ~ make.names(.x, unique = TRUE)) %>% 
              transmute(year = as.numeric(X),
                        gini = Gini.s..concentra.tion..coefficient,
                        equiv_scale = "hh",
                        link = tdgbas_link2) %>% 
              filter(!is.na(gini)),
    read_csv("data-raw/tdgbas3.csv", 
                     col_names = c("year", "gini"), 
                     col_types = "id", 
                     skip = 4) %>% 
              filter(!is.na(year)) %>% 
              mutate(equiv_scale = "hh",
                     link = tdgbas_link3)) %>% 
  distinct(year, gini, equiv_scale, .keep_all = TRUE) %>% 
  transmute(country = "Taiwan",
            year = year,
            gini = gini,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = equiv_scale,
            monetary = FALSE,
            series = paste("DGBAS", welfare_def, equiv_scale),
            source1 = "Taiwan Directorate General of Budget, Accounting, and Statistics",
            page = "",
            link = link)


# National Statistics Office of Thailand (archived)
nso_thailand1_link <- "https://web.archive.org/web/20101113152831/http://web.nso.go.th/eng/en/stat/socio/soctab6.htm"
nso_thailand2_link <- "https://web.archive.org/web/20100523041410/http://web.nso.go.th:80/eng/en/indicators/eco/ied-e.htm"

nso_thailand1 <- read_html(nso_thailand1_link) %>% 
  html_node(".F2 table") %>% 
  html_table(header = TRUE) %>% 
  filter(`Quintile Group` == "Gini Coefficient") %>% 
  select(-`Quintile Group`) %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Thailand",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "hh",
            monetary = FALSE,
            series = paste("NSO Thailand", welfare_def, equiv_scale),
            source1 = "National Statistical Office of Thailand",
            page = "",
            link = nso_thailand1_link) %>% 
  filter(year < 1998)

nso_thailand2 <- read_html(nso_thailand2_link) %>% 
  html_node(".F2") %>% 
  html_table() %>% 
  filter(str_detect(X2, "Indicators|Gini")) %>% 
  select(-X1, -X8) %>% 
  first_row_to_names() %>% 
  gather(key = year, value = gini, -Indicators) %>% 
  transmute(country = "Thailand",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(str_extract(gini, "[\\d\\.]*")),
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = if_else(str_detect(Indicators, "household"), "hh", "pc"),
            monetary = FALSE,
            series = paste("NSO Thailand", welfare_def, equiv_scale),
            source1 = "National Statistical Office of Thailand",
            page = "",
            link = nso_thailand2_link)

nso_thailand <- bind_rows(nso_thailand1, nso_thailand2)

rm(nso_thailand1, nso_thailand2)

# NESDC Thailand (archived; check for update)
nesdc_link <- c("https://web.archive.org/web/20231231113955/https://www.nesdc.go.th/ewt_dl_link.php?nid=3518&filename=social")
download.file(nesdc_link, "data-raw/nesdc.xlsx")

nesdc_gross <- read_excel("data-raw/nesdc.xlsx", sheet = "8.1", skip = 2) %>%
  select(year = 1, gini = 2) %>% 
  filter(str_detect(year, "^\\d{4}")) %>% 
  transmute(country = "Thailand",
            year = as.numeric(str_extract(year, "\\d{4}"))-543,
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("NESDC Thailand", welfare_def, equiv_scale),
            source1 = "NESDC Thailand",
            page = "8.1",
            link = nesdc_link)

nesdc_con <- read_excel("data-raw/nesdc.xlsx", sheet = "9.1", skip = 3) %>% 
  select(year = 1, gini = 2) %>% 
  filter(str_detect(year, "^\\d{4}")) %>% 
  transmute(country = "Thailand",
            year = as.numeric(str_extract(year, "\\d{4}"))-543,
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("NESDC Thailand", welfare_def, equiv_scale),
            source1 = "NESDC Thailand",
            page = "",
            link = nesdc_link)

nesdc <- bind_rows(nesdc_gross, nesdc_con)

rm(nesdc_gross, nesdc_con)


# Statistics Turkey (update files)
# https://data.tuik.gov.tr/en > Income, Living, Consumption, and Poverty > 
# [Check] Income Distribution and Living Conditions Statistics [Search] > 
# [Select tab] Statistical Table > 'Gini coefficient, S80/S20 and S90/S10 ratios' under Equivalised Household Disposable Income & under Household Disposable Income
tuik_link <- "https://data.tuik.gov.tr/Kategori/GetKategori?p=Income,-Living,-Consumption-and-Poverty-107"

tuik_oecdm <- read_excel("data-raw/tuik_oecdm.xls", skip = 3) %>% 
    slice(c(1, 3)) %>% 
    rename(wd = `...1`) %>% 
    pivot_longer(-wd, names_to = "year", values_to = "gini") %>% 
    filter(year!="...1") %>% 
    transmute(country = "Turkey",
              year = as.numeric(year),
              gini = as.numeric(gini),
              gini_se = NA,
              welfare_def = if_else(str_detect(wd, "Before"), "market", "disp"),
              equiv_scale = "oecdm",
              monetary = FALSE,
              series = paste("TUIK", welfare_def, equiv_scale),
              source1 = "Turkish Statistical Institute",
              page = "",
              link = tuik_link)

tuik_hh <- read_excel("data-raw/tuik_hh.xls", skip = 3) %>% 
    filter(str_detect(`...1`, "Gini")) %>% 
    gather(key = year, value = gini) %>% 
    filter(year!="...1") %>% 
    transmute(country = "Turkey",
              year = as.numeric(year),
              gini = as.numeric(gini),
              gini_se = NA,
              welfare_def = "disp",
              equiv_scale = "hh",
              monetary = FALSE,
              series = paste("TUIK", welfare_def, equiv_scale),
              source1 = "Turkish Statistical Institute",
              page = "",
              link = tuik_link)

tuik <- bind_rows(tuik_oecdm, tuik_hh)

rm(tuik_hh, tuik_oecdm)


# U.K. Office for National Statistics (update links; join with latest file last)
# https://www.ons.gov.uk/atoz?query=effects+taxes+benefits (new releases in April and January)
ons_link <- "https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/householddisposableincomeandinequality/financialyearending2024/hdiifye2024final.xlsx"
# archived
ons_link2 <- "https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/theeffectsoftaxesandbenefitsonhouseholdincomefinancialyearending2014/financialyearending2022/etbreferencetablesfye2022correction.xlsx"

download.file(ons_link, "data-raw/ons.xlsx")
download.file(ons_link2, "data-raw/ons2.xlsx")

ons2 <- read_excel("data-raw/ons2.xlsx", sheet = "Table 6a", skip = 3) %>% 
  janitor::clean_names() %>% 
  select(year, original_income, gross_income, disposable_income, expenditure) %>% 
  pivot_longer(cols = matches("[_x]"), 
               names_to = c("wd", "series0"),
               names_sep = "_",
               values_to = "gini") %>% 
  mutate(welfare_def = case_when(wd == "original" ~ "market",
                                 wd == "gross" ~ "gross",
                                 wd == "disposable" ~ "disp",
                                 wd == "expenditure" ~ "con",
                                 TRUE ~ NA_character_),
         gini = as.numeric(gini)/100,
         gini_se = case_when(wd == "original" ~ gini * .015, # per Table 11
                                 wd == "gross" ~ gini * .02,
                                 wd == "disposable" ~ gini * .018,
                                 TRUE ~ NA_real_),
         series = 1) %>% 
  filter(!is.na(gini) & !is.na(welfare_def)) %>% 
  transmute(country = "United Kingdom",
            year = ifelse(str_extract(year, "\\d{2}$") %>% as.numeric() > 70,
                          str_extract(year, "\\d{2}$") %>% as.numeric() + 1900,
                          str_extract(year, "\\d{2}$") %>% as.numeric() + 2000),
            gini = gini,
            gini_se = gini_se,
            welfare_def = welfare_def,
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("ONS", welfare_def, equiv_scale, series),
            source1 = "UK Office for National Statistics",
            page = "",
            link = ons_link) %>% 
  filter(welfare_def == "con")

ons <- read_excel("data-raw/ons.xlsx", sheet = "Table 9", skip = 6) %>% 
  janitor::clean_names() %>% 
  select(year, original_2, gross_3, disposable_4) %>% 
  pivot_longer(cols = matches("[_x]"), 
               names_to = c("wd", "series0"),
               names_sep = "_",
               values_to = "gini") %>% 
  mutate(welfare_def = case_when(wd == "original" ~ "market",
                                 wd == "gross" ~ "gross",
                                 wd == "disposable" ~ "disp",
                                 wd == "expenditure" ~ "con",
                                 TRUE ~ NA_character_),
         gini = as.numeric(gini)/100,
         gini_se = case_when(wd == "original" ~ gini * .015, # per Table 11
                             wd == "gross" ~ gini * .02,
                             wd == "disposable" ~ gini * .018,
                             TRUE ~ NA_real_),
         series = 1) %>% 
  filter(!is.na(gini) & !is.na(welfare_def)) %>% 
  transmute(country = "United Kingdom",
            year = ifelse(str_extract(year, "\\d{2}$") %>% as.numeric() > 70,
                          str_extract(year, "\\d{2}$") %>% as.numeric() + 1900,
                          str_extract(year, "\\d{2}$") %>% as.numeric() + 2000),
            gini = gini,
            gini_se = gini_se,
            welfare_def = welfare_def,
            equiv_scale = "oecdm",
            monetary = FALSE,
            series = paste("ONS", welfare_def, equiv_scale, series),
            source1 = "UK Office for National Statistics",
            page = "",
            link = ons_link) %>% 
  bind_rows(ons2) %>% 
  distinct(year, gini, welfare_def, equiv_scale, .keep_all = TRUE)

rm(ons2)

# U.K. Institute for Fiscal Studies (update link)
# user_a <- httr::user_agent("Mozilla/5.0 (Macintosh; Intel Mac OS X 12_0_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36")
# ifs <- "https://ifs.org.uk/living-standards-poverty-and-inequality-uk" %>%
#   session(user_a) %>%
#   session_follow_link("spreadsheet")
# writeBin(httr::content(ifs$response, "raw"), "data-raw/ifs.xlsx")
# ifs_link <- ifs$response$url

ifs_link <- "https://ifs.org.uk/sites/default/files/2025-03/Incomes%2C%20poverty%20and%20inequality_0.xlsx"
download.file(ifs_link, "data-raw/ifs.xlsx")

ifs <- read_excel("data-raw/ifs.xlsx", sheet = 5, col_names = FALSE, skip = 3,
                  .name_repair = ~ make.names(.x, unique = TRUE)) %>%
  select(X:X.3) %>%
  filter(!is.na(X.1)) %>% 
  transmute(country = "United Kingdom",
            year = ifelse(str_extract(X.1, "\\d{2}$") %>% as.numeric() > 50,
                          str_extract(X.1, "\\d{2}$") %>% as.numeric() + 1900,
                          str_extract(X.1, "\\d{2}$") %>% as.numeric() + 2000),
            gini = as.numeric(X.3) %>% round(4),
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "oecdm",
            monetary = TRUE,
            series = paste("IFS", X.2, welfare_def, equiv_scale),
            source1 = "Institute for Fiscal Studies",
            page = "",
            link = ifs_link)


# U.S. Congressional Budget Office (update link)
# https://www.cbo.gov/search?search_api_fulltext=gini >
# The Distribution of Household Income, 20xx >
# Data Underlying Figures and Tables
cbo_link <- "https://www.cbo.gov/system/files/2024-09/60341-data.xlsx"
download.file(cbo_link, "data-raw/cbo.xlsx")

cbo <- read_excel("data-raw/cbo.xlsx", sheet = "Figure 14", col_names = FALSE, skip = 8,
                  .name_repair = ~ make.names(.x, unique = TRUE)) %>% 
  filter(!is.na(as.numeric(X)) & !is.na(X.1)) %>% 
  transmute(year = as.numeric(X),
            market = as.numeric(X.1),
            disp = as.numeric(X.2)) %>% 
  filter(!is.na(year)) %>% 
  gather(key = welfare_def, 
         value = gini,
         market:disp) %>% 
  mutate(country = "United States",
         gini_se = NA,
         equiv_scale = "sqrt",
         monetary = TRUE,
         series = paste("CBO", welfare_def, "sqrt"),
         source1 = "U.S. Congressional Budget Office",
         page = "",
         link = cbo_link)


# U.S. Census Bureau (update link [probably only /p60/xxx/tableA] and wrangle; updated in Sept)
# https://www.census.gov/topics/income-poverty/income-inequality/data/data-tables.html
# Selected Measures of Household Income Dispersion:  1967 to 20xx
# Selected Measures of Equivalence-Adjusted Income Dispersion: 1967 to 20xx

uscb_links <- paste0("https://www2.census.gov/programs-surveys/demo/tables/p60/282/tableA", c("4b", 5), ".xlsx")
download.file(uscb_links[1], "data-raw/uscb_hh.xlsx")
download.file(uscb_links[2], "data-raw/uscb_ae.xlsx")

download.file("https://github.com/fsolt/swiid/raw/015a7a1f19f68b77bcc3a5a315fb27745b4fc33f/data-raw/uscb_hh.xlsx", 
              "data-raw/uscb_hh_se.xlsx")

download.file("https://github.com/fsolt/swiid/raw/015a7a1f19f68b77bcc3a5a315fb27745b4fc33f/data-raw/uscb_ae.xlsx", 
              "data-raw/uscb_ae_se.xlsx")

uscb_hh_se <- read_excel("data-raw/uscb_hh_se.xlsx", skip = 3) %>% 
  filter(str_detect(`Measures of income dispersion`, "Gini")) %>% 
  mutate(var = c("gini", "gini_se")) %>% 
  select(-`Measures of income dispersion`) %>% 
  gather(key = year, value = value, -var) %>% 
  spread(key = var, value = value) %>% 
  mutate(year = as.numeric(str_extract(year, "\\d{4}")),
         gini = as.numeric(gini),
         gini_se = as.numeric(gini_se),
         break_yr = (year == 1993 | (year == 2013 & gini_se > .005) | (year == 2017 & gini_se == 0.0036) | year == 2020)) %>%
  arrange(year, break_yr) %>% 
  transmute(country = "United States",
            year = year,
            gini_se = gini_se,
            welfare_def = "gross",
            equiv_scale = "hh",
            monetary = TRUE,
            series = paste("US Census Bureau", welfare_def, equiv_scale, cumsum(break_yr) + 1),
            source1 = "U.S. Census Bureau",
            page = "",
            link = uscb_links[1])

uscb_hh <- read_excel("data-raw/uscb_hh.xlsx", skip = 6) %>% 
  clean_names() %>% 
  filter(str_detect(x1, "^\\d{4}")) %>% 
  transmute(year = as.numeric(str_extract(x1, "\\d{4}")),
         gini = as.numeric(x14),
         break_yr = (year == 1993 | (year == 2013 & gini > .48) | (year == 2017 & gini == .489) | year == 2020)) %>%
  arrange(year, break_yr) %>% 
  transmute(country = "United States",
            year = year,
            gini = gini,
            welfare_def = "gross",
            equiv_scale = "hh",
            monetary = TRUE,
            series = paste("US Census Bureau", welfare_def, equiv_scale, cumsum(break_yr) + 1),
            source1 = "U.S. Census Bureau",
            page = "",
            link = uscb_links[1]) %>% 
  left_join(uscb_hh_se, by = c("country", "year", "welfare_def", "equiv_scale",
                               "monetary", "series", "source1", "page", "link"))

uscb_ae_se <- read_excel("data-raw/uscb_ae_se.xlsx", skip = 3) %>% 
  filter(str_detect(`Measures of income dispersion`, "Gini")) %>% 
  mutate(var = c("gini", "gini_se")) %>% 
  select(-`Measures of income dispersion`) %>% 
  gather(key = year, value = value, -var) %>% 
  spread(key = var, value = value) %>% 
  mutate(year = as.numeric(str_extract(year, "\\d{4}")),
         gini = as.numeric(gini),
         gini_se = as.numeric(gini_se),
         break_yr = (year == 1993 | (year == 2013 & gini_se == .0064) | (year == 2017 & gini_se == 0.0036) | year == 2020)) %>%
  arrange(year, break_yr) %>% 
  transmute(country = "United States",
            year = year,
            gini_se = gini_se,
            welfare_def = "gross",
            equiv_scale = "ae",
            series = paste("US Census Bureau", welfare_def, equiv_scale, cumsum(break_yr) + 1))

uscb_ae <- read_excel("data-raw/uscb_ae.xlsx", skip = 6) %>% 
  clean_names() %>% 
  filter(str_detect(x1, "^\\d{4}")) %>% 
  transmute(year = as.numeric(str_extract(x1, "\\d{4}")),
            gini = as.numeric(x10),
            break_yr = (year == 1993 | (year == 2013 & gini > .46) | (year == 2017 & gini == .471) | year == 2020)) %>%
  arrange(year, break_yr) %>% 
  filter(!is.na(gini)) %>% 
  transmute(country = "United States",
            year = year,
            gini = gini,
            welfare_def = "gross",
            equiv_scale = "ae",
            monetary = TRUE,
            series = paste("US Census Bureau", welfare_def, equiv_scale, cumsum(break_yr) + 1),
            source1 = "U.S. Census Bureau",
            page = "",
            link = uscb_links[2]) %>% 
  left_join(uscb_ae_se, by = c("country", "year", "welfare_def", "equiv_scale", "series"))

uscb_fam_link <- "https://www2.census.gov/library/publications/1998/demographics/p60-203.pdf"
download.file(uscb_fam_link, "data-raw/uscb1998.pdf")

uscb_fam0 <- extract_tables("data-raw/uscb1998.pdf", pages = 102)[[1]] %>% 
    separate_wider_delim(Gini...2, " ",
                         names = c("Gini...2", "...20"),
                         too_few = "align_start") %>% 
    mutate(across(everything(), as.character))
uscb_fam <- as_tibble(uscb_fam0[3:15,1:2]) %>% 
  bind_rows(as_tibble(uscb_fam0[3:15,c(3,5)])) %>% 
  bind_rows(as_tibble(uscb_fam0[3:15,c(6,8)])) %>% 
  bind_rows(as_tibble(uscb_fam0[3:15,c(9,12)])) %>% 
  transmute(country = "United States",
            year = as.numeric(str_extract(...1, "19\\d{2}")),
            gini = as.numeric(Gini),
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "hh",
            monetary = TRUE,
            series = paste("US Census Bureau", welfare_def, equiv_scale, "family"),
            source1 = "U.S. Census Bureau 1998",
            page = "102",
            link = uscb_fam_link) %>% 
  filter(year>=1960)

uscb <- bind_rows(uscb_ae, uscb_hh, uscb_fam)
rm(uscb_ae, uscb_hh, uscb_fam, uscb_fam0)


# Uruguay Instituto Nacional de Estadística (archived)
# add new observations (from 2018 onward) to fs_added_data
uine_link1 <- "https://web.archive.org/web/20151016101651/https://www.ine.gub.uy/documents/10181/35933/Informe+pobreza+y+desigualdad.pdf/2a797c4b-fec4-410e-bd7e-da7a57841112"
#download.file(uine_link1, "data-raw/uine1.pdf")

uine1 <- extract_tables("data-raw/uine1.pdf", pages = 13,
                        area = list(c(122.1, 87.4, 284.8, 515.9)),
                        guess = FALSE)[[1]] %>% 
  mutate(imputed_rent = str_extract(Región, "Sin|Con"),
         imputed_rent = zoo::na.locf(imputed_rent, na.rm = FALSE),
         monetary = (imputed_rent=="Sin")) %>% 
  filter(Región == "Total país") %>% 
  select(-Región, -imputed_rent) %>% 
  pivot_longer(cols = matches("\\d"), names_to = "year", values_to = "gini") %>% 
  transmute(country = "Uruguay",
            year = as.numeric(year),
            gini = as.numeric(sub(",", ".", gini, fixed = TRUE)),
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = monetary,
            series = paste("Instituto Nacional de Estadistica Uruguay", welfare_def, equiv_scale, as.numeric(as.factor(1-monetary))),
            source1 = "Instituto Nacional de Estadística Uruguay",
            page = "11",
            link = uine_link1)

uine_link2 <- "https://web.archive.org/web/20181114034033/https://www.ine.gub.uy/c/document_library/get_file?uuid=8504f46a-ed45-40e5-9a25-12c1b0c869ac&groupId=10181"
# download.file(uine_link2, "data-raw/uine2.xlsx")

uine2 <- read_excel("data-raw/uine2.xlsx", skip = 3) %>% 
  select(year = 1,
         gini = 2) %>% 
  filter(!is.na(gini)) %>% 
  transmute(country = "Uruguay",
            year = as.numeric(year),
            gini = gini,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = FALSE,
            series = paste("Instituto Nacional de Estadistica Uruguay", welfare_def, equiv_scale, "3"),
            source1 = "Instituto Nacional de Estadística Uruguay",
            page = "45",
            link = uine_link2)

uine <- bind_rows(uine1, uine2)

# Venezuela Instituto Nacional de Estadística (update file)
# http://www.ine.gov.ve/ > Sociales tab > Coeficiente Gini tab
inev_link <- "http://www.ine.gob.ve/index.php?option=com_content&view=category&id=104&Itemid=45#"
# download.file(inev_link, "data-raw/inev.xls")

inev <- read_excel("data-raw/inev.xls", skip = 2) %>% 
  select(matches("[AV]")) %>% 
  filter(!is.na(`Año...1`) & str_detect(`Año...1`, "\\d")) %>% 
  mutate(across(.cols = everything(), .fns = as.numeric)) %>% 
  pivot_longer(cols = everything(), 
               names_to = c("var", "set"),
               names_sep = "\\.\\.\\.",
               values_to = "value") %>% 
  mutate(var = if_else(str_detect(var, "A"), "year", "gini"),
         year = if_else(var=="year",
                        value,
                        lag(value))) %>% 
  filter(!is.na(value) & value < 1) %>% 
  transmute(country = "Venezuela",
            year = year,
            gini = value,
            gini_se = NA,
            welfare_def = "disp",
            equiv_scale = "pc",
            monetary = TRUE,
            series = paste("Instituto Nacional de Estadistica Venezuela", welfare_def, equiv_scale),
            source1 = "Instituto Nacional de Estadística Venezuela",
            page = "",
            link = inev_link)


# General Statistics Office of Vietnam (update file for gso_vn2; check 'page')
# https://www.gso.gov.vn/en/px-web/?pxid=E1439&theme=Health%2C%20Culture%2C%20Sport%20and%20Living%20standard
# WHOLE COUNTRY, all years > Comma delimited with heading
gso_vn1_link <- "https://web.archive.org/web/20170525163734/http://www.gso.gov.vn/Modules/Doc_Download.aspx?DocID=16773"
gso_vn2_link <- "https://www.gso.gov.vn/en/px-web/?pxid=E1439&theme=Health%2C%20Culture%2C%20Sport%20and%20Living%20standard"
# download.file(gso_vn1_link, "data-raw/gso_vn2013.pdf")

gso_vn1 <- extract_tables("data-raw/gso_vn2013.pdf", pages = 84)[[1]] %>% 
  filter(str_detect(...1, "TOTAL") | is.na(...1)) %>% 
  select(-...1) %>% 
  first_row_to_names() %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Vietnam",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(gini),
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = TRUE,
            series = paste("GSO Vietnam", welfare_def, equiv_scale),
            source1 = "General Statistics Office of Vietnam 2013",
            page = "84",
            link = gso_vn1_link)

gso_vn2 <- read_csv("data-raw/gso_vn2.csv", skip = 2,
                    col_types = cols(Items = col_character(),
                                     .default = col_double())) %>% 
  filter(Items == "WHOLE COUNTRY") %>% 
  select(-Items) %>% 
  gather(key = year, value = gini) %>% 
  transmute(country = "Vietnam",
            year = as.numeric(str_extract(year, "\\d{4}")),
            gini = as.numeric(str_replace(gini, ",", ".")),
            gini_se = NA,
            welfare_def = "gross",
            equiv_scale = "pc",
            monetary = TRUE,
            series = paste("GSO Vietnam", welfare_def, equiv_scale),
            source1 = "General Statistics Office of Vietnam",
            page = "",
            link = gso_vn2_link)  

gso_vn <- bind_rows(gso_vn1, gso_vn2)

rm(gso_vn1, gso_vn2)

# Additional Inequality Datasets

# Milanovic All the Ginis (update if possible)
atg_link <- "https://www.dropbox.com/s/h3riybl79nk6fft/allginis_2016.dta?dl=1"
tryCatch(writeBin(httr::content(html_session(atg_link)$response, "raw"), "data-raw/atg.dta"), 
         error = function(e) {
           download.file("https://github.com/fsolt/swiid/raw/master/data-raw/atg.dta", "data-raw/atg.dta")
         })

atg0 <- haven::read_dta("data-raw/atg.dta", encoding = "latin1") %>% 
  select(contcod, year, ends_with("_INDIE")) %>% 
  filter(!is.na(gini_INDIE)) %>% 
  mutate(country = countrycode(contcod, "wb_api3c", "swiid.name", custom_dict = cc_swiid)) %>% 
  filter(country == "United Kingdom") %>% 
  transmute(country = country,
            year = year,
            gini = gini_INDIE/100,
            gini_se = NA,
            welfare_def = if_else(Dinc_INDIE == 0, "con",
                                  if_else(Dgross_INDIE == 1, "gross", "disp")),
            equiv_scale = if_else(Dhh_INDIE == 1, "hh", "pc"),
            monetary = NA,
            series = paste("AtG", country, welfare_def, equiv_scale),
            source1 = "Milanovic 2016",
            page = "",
            link = atg_link)

brandolini <- haven::read_dta("data-raw/atg.dta", encoding = "latin1") %>% 
  select(contcod, year, ends_with("_INDIE")) %>% 
  filter(!is.na(gini_INDIE)) %>% 
  mutate(country = countrycode(contcod, "wb_api3c", "swiid.name", custom_dict = cc_swiid)) %>% 
  filter(country == "France" | country == "Germany" | country == "Canada" | country == "Netherlands") %>% 
  transmute(country = country,
            year = year,
            gini = gini_INDIE/100,
            gini_se = NA,
            welfare_def = if_else(Dinc_INDIE == 0, "con",
                                  if_else(Dgross_INDIE == 1, "gross", "disp")),
            equiv_scale = if_else(Dhh_INDIE == 1, "hh", "pc"),
            monetary = NA,
            series = paste("Brandolini1998", country, welfare_def, equiv_scale),
            source1 = "Milanovic 2016; Brandolini 1998",
            page = "",
            link = atg_link)

atg <- bind_rows(atg0, brandolini) %>% 
  filter(year >= 1960)

rm(atg0, brandolini)


# Global Income Distribution Database (Ackah, Bussolo, De Hoyas, and Medvedev 2008, archived)
# see http://siteresources.worldbank.org/INTPROSPECTS/Resources/334934-1225141925900/GIDDdatasetpaper.doc
gidd_link <- "https://github.com/fsolt/swiid/raw/master/data-raw/GlobalDistStata.zip"
download.file(gidd_link, "data-raw/GlobalDistStata.zip")

con <- c("Algeria", "Angola", "Bhutan", "Bosnia & Herzegovina", "Botswana", "Cape Verde",
         "Central African Rep.", "Chad", "Comoros", "Congo, Dem. Rep. Of", "Congo, Republic of",
         "Djibouti", "Egypt", "Gabon", "Guinea-Bissau", "Iran, I.R. of", "Lesotho", "Liberia",
         "Malawi", "Malaysia", "Mongolia", "Mozambique", "Namibia", "Niger", "Papua New Guinea",
         "Rwanda", "Sierra Leone", "St. Lucia", "Suriname", "Swaziland", "Togo", 
         "Trinidad and Tobago", "Tunisia", "Turkmenistan", "Zambia")

gidd_raw <- haven::read_dta(unz("data-raw/GlobalDistStata.zip", "global_dist March 12, 2009.dta")) %>% 
  filter(!countrylong == "") %>%
  filter(incsource == 1 | countrylong %in% con) %>% 
  mutate(countrylong = if_else(countrylong == "Central African Rep.",
                               "Central African Republic",
                               countrylong))

get_gini <- function(data, x, weight) {
  x <- data[[x]]
  weight <- data[[weight]]
  ox <- order(x)
  x <- as.vector(x)[ox]
  weight <- as.vector(weight)[ox] / sum(weight) 
  p <- cumsum(weight)
  nu <- cumsum(weight * x)
  n <- length(nu)
  nu <- nu / nu[n]
  res <- round((sum(nu[-1] * p[-n]) - sum(nu[-n] * p[-1])), digits = 3)
  return(res)
}

gidd <- map_df(gidd_raw$countrylong %>% unique(), function(x) {
  gini <- get_gini(gidd_raw %>% 
                     filter(countrylong == x), "consincPPP05", "pop")
  df <- gidd_raw %>% 
    filter(countrylong == x) %>% 
    summarize(country = first(countrylong),
              year = first(year),
              gini = gini)
  
  return(df)
}) %>% 
  transmute(country = countrycode(country, "country.name.en.regex", "swiid.name", custom_dict = cc_swiid),
            year = year,
            gini = gini,
            gini_se = NA,
            welfare_def = "con",
            equiv_scale = "pc",
            monetary = NA,
            series = paste("GIDD", country, welfare_def, equiv_scale),
            source1 = "Ackah, Bussolo, De Hoyos, and Medvedev 2008",
            page = "",
            link = gidd_link)

rm(gidd_raw)


## Added data
added_data <- read_csv("data-raw/fs_added_data.csv",
                       col_types = "ciddcclcccc")

## Combine
make_inputs <- function(baseline_series, nbl = FALSE) {
  se_factor <- 3
  # first, get baseline series and order by data-richness
  baseline_wd <- str_split(baseline_series, "\\s")[[1]] %>% nth(-2)
  baseline_es <- str_split(baseline_series, "\\s")[[1]] %>% last()
  baseline_wdes <- paste0(baseline_wd, "_", baseline_es)
  baseline <- lis %>% 
    filter(series == baseline_series) %>% 
    mutate(gini_b = gini,
           gini_b_se = gini_se * se_factor) %>%
    select(-gini, -gini_se) %>%
    mutate(country = countrycode(country, "country.name.en.regex", "swiid.name", custom_dict = cc_swiid),
           region = countrycode(country, "swiid.name", "swiid.region", custom_dict = {cc_swiid %>% distinct(swiid.name, .keep_all = TRUE)})) %>% 
    group_by(region) %>% 
    mutate(r_bl_obs = n()) %>% 
    ungroup() %>% 
    group_by(country) %>% 
    mutate(k_bl_obs = n()) %>% 
    ungroup() %>% 
    arrange(desc(k_bl_obs))
  
  # turn cross-country series into within-country series
  oecd1 <- oecd %>% 
    mutate(series = paste("OECD", country, str_replace(series, "OECD ", "")))
  ceq1 <- ceq %>% 
    mutate(series = paste("CEQ", country, str_replace(series, "CEQ ", "")))
  lis1 <- lis %>% 
    mutate(series = paste("LIS", country, str_replace(series, "LIS ", "")))
  
  # then combine with other series ordered by data-richness
  ineq0 <- bind_rows(lis1, erflis,
                     sedlac, cepal, cepal_sdi, oecd1, eurostat,
                     transmonee, ceq1, afr_gini, wb,
                     armstat, abs, inebo, ipea, belstat, statcan, dane, ineccr, dkstat,
                     capmas, statee, statfi, insee, geostat, greenland,
                     stathk, bpsid, amar, cso_ie, istat, statinja, kazstat, kostat, nsck,
                     epumy, nbs, monstat, snz, nzmsd, ssb, dgeec, psa,
                     rosstat, ru_lis_old, singstat, ssi, ine, statslk, scb, fso_ch,
                     tdgbas, nso_thailand, nesdc, tuik, ons, ifs, cbo, uscb, uine, inev, gso_vn,
                     atg, gidd,
                     added_data) %>% 
    rename(gini_m = gini,
           gini_m_se = gini_se) %>%
    mutate(country = countrycode(country, "country.name.en.regex", "swiid.name", custom_dict = cc_swiid),
           region = countrycode(country, "swiid.name", "swiid.region", custom_dict = {cc_swiid %>% distinct(swiid.name, .keep_all = TRUE)})) %>% 
    filter(!is.na(region)) %>% 
    group_by(country) %>% 
    mutate(country_obs = n()) %>% 
    ungroup() %>% 
    group_by(country, series) %>% 
    mutate(series_obs = n()) %>%
    ungroup() %>% 
    arrange(desc(country_obs), desc(series_obs)) 
  
  if (str_detect(baseline_series, "market") & nbl == TRUE) {
    ineq0 <- ineq0 %>% 
      filter(welfare_def == "market")
  } 
  
  # obs with baseline data
  ineq_bl <- ineq0 %>% 
    right_join(baseline %>% 
                 select(country, year, gini_b, gini_b_se, r_bl_obs, k_bl_obs),
               by = c("country", "year")) %>% 
    arrange(desc(r_bl_obs), desc(k_bl_obs)) %>% 
    group_by(country, series) 
  
  ineq_bl_series <- ineq_bl %>% pull(series) %>% unique()
  
  # obs with no baseline data from series with some baseline data ("overlap baseline")
  ineq_obl <- ineq0 %>% anti_join(ineq_bl %>% select(-gini_b, -gini_b_se), 
                                  by = c("country", "year")) %>% 
    filter(series %in% ineq_bl_series) %>% 
    group_by(country, series)
  
  # obs from series with no baseline data
  ineq_nbl <- ineq0 %>% anti_join(ineq_bl %>% select(-gini_b, -gini_b_se), 
                                  by = c("country", "year")) %>% 
    filter(!series %in% ineq_bl_series)
  
  ineq_oth_series <- bind_rows(ineq_obl, ineq_nbl) %>% pull(series) %>% unique()
  
  # combine all
  ineq <- bind_rows(ineq_bl, ineq_obl, ineq_nbl) %>% 
    group_by(series) %>% 
    mutate(s_bl_obs = sum(!is.na(gini_b))) %>% 
    ungroup() %>% 
    group_by(country) %>% 
    mutate(k_bl_obs = if_else(!is.na(mean(k_bl_obs, na.rm = TRUE)),
                              mean(k_bl_obs, na.rm = TRUE), 0),
           tcode0 = year - min(year) + 1) %>% 
    ungroup() %>% 
    arrange(desc(k_bl_obs), desc(country_obs)) %>% 
    mutate(gini_m_se = if_else(!is.na(gini_m_se), if_else(gini_m_se < .0025, .005, gini_m_se * se_factor),
                              quantile(gini_m_se/gini_m, .99, na.rm = TRUE) * gini_m * se_factor) %>% 
             if_else(. < .01, .01, .),
           wdes = paste(welfare_def, equiv_scale, sep = "_"),
           ibl = (gini_m == gini_b & str_detect(series, paste("LIS .*", baseline_wd, baseline_es))),
           bl = (!is.na(gini_b)),
           obl = (s_bl_obs > 2),
           kbl = (k_bl_obs > 0),
           kcode = as.integer(factor(country, levels = unique(country))),
           tcode = tcode0,
           rcode = as.integer(factor(region, levels = unique(region))),
           wcode = as.integer(factor(welfare_def) %>% forcats::fct_relevel(baseline_wd)),
           ecode = as.integer(factor(equiv_scale) %>% forcats::fct_relevel(baseline_es)),
           wecode = as.integer(factor(paste(wcode, ecode))),
           kwecode = as.integer(factor(100*kcode+wecode)),
           rwecode = as.integer(factor(100*rcode+wecode))) %>% 
    select(-tcode0) # tcode0 is only used to facilitate getting tcode into its customary column position
  
  wecodes <- ineq %>%
    select(wdes, wecode, wcode, ecode) %>% 
    distinct() %>% 
    mutate(wd = str_replace(wdes, "_.*", ""),
           es = str_replace(wdes, ".*_", "")) %>% 
    arrange(wecode)
  
  kwecodes <- ineq %>%
    select(wecode, kcode, kwecode, rwecode) %>% 
    distinct()
  
  ineq1 <- ineq %>% 
    group_by(kcode, tcode, welfare_def, equiv_scale) %>% 
    summarize(n_obs = n(),
              gini_cat = mean(gini_m), 
              gini_cat_se = ifelse(n_obs == 1,
                                   gini_m_se,
                                   sqrt(mean(gini_m_se^2) + (1+1/n_obs)*var(gini_m))),
              .groups = "drop") %>%  # per Rubin (1987)
    select(-n_obs) %>% 
    unite(wdes, welfare_def, equiv_scale) %>% 
    bind_rows(ineq %>%
                group_by(kcode, tcode) %>% 
                summarize(gini_cat = first(gini_b),
                          gini_cat_se = first(gini_b_se),
                          wdes = "baseline",
                          .groups = "drop"))
  
  
  ## Generate ratios
  # generate ratios of baseline to each wd_es 
  rho_we0 <- ineq1 %>% 
    select(-gini_cat_se) %>% 
    spread(key = wdes, value = gini_cat) %>% 
    mutate_at(vars(matches("_")),
              list(~baseline/.)) %>% 
    select(-baseline) %>% 
    gather(key = wdes, value = rho, -kcode, -tcode) %>% 
    filter(!is.na(rho)) %>% 
    arrange(kcode, tcode, wdes)
  
  rho_we_se <- ineq1 %>% 
    select(-gini_cat) %>% 
    spread(key = wdes, value = gini_cat_se) %>% 
    mutate_at(vars(matches("_")),
              list(~sqrt(baseline^2+.^2))) %>% 
    select(-matches("baseline")) %>% 
    gather(key = wdes, value = rho_se, -kcode, -tcode) %>% 
    filter(!is.na(rho_se)) %>% 
    arrange(kcode, tcode, wdes)
  
  rho_we00 <- rho_we0 %>% 
    left_join(rho_we_se, by = c("kcode", "tcode", "wdes")) %>% 
    mutate(rho_se = if_else(rho == 1, .1, rho_se)) %>%            # placeholder for baseline series
    left_join(ineq %>% select(country, year, kcode, tcode, rcode) %>% distinct(),
              by = c("kcode", "tcode")) %>% 
    left_join(wecodes, by = "wdes") %>% 
    left_join(kwecodes, by = c("kcode", "wecode"))
  
  rcodes_not_miss <- rho_we00 %>%                       # regions with no observed ratios to baseline series
    filter(!rho == 1) %>%
    select(rcode, wdes) %>% 
    filter(wdes == baseline_wdes) %>% 
    unique() %>% 
    pull(rcode)
  
  rho_we <- rho_we00 %>% 
    filter(!(rho == 1 & (rcode %in% rcodes_not_miss)))  # use placeholder if no observed ratios to baseline series
  
  rm(rho_we0, rho_we_se)
  
  # generate ratios of baseline_wd to each wd (for all constant es)
  rho_wd0 <- map_df(c("pc", "hh", "sqrt", "oecdm", "ae"), function(e) {
    ineq1 %>% 
      select(-gini_cat_se) %>% 
      spread(key = wdes, value = gini_cat) %>% 
      mutate(bl = get(paste0(baseline_wd, "_", e))) %>% 
      mutate_at(vars(matches(e)),
                list(~bl/.)) %>% 
      select(kcode, tcode, matches(e)) %>% 
      gather(key = wdes, value = rho_wd, -kcode, -tcode) %>% 
      filter(!is.na(rho_wd)) %>% 
      mutate(wd = str_replace(wdes, "_.*", "")) %>% 
      select(-wdes) %>% 
      arrange(kcode, tcode, wd)
  })
  
  rho_wd_se <- map_df(c("pc", "hh", "sqrt", "oecdm", "ae"), function(e) {
    ineq1 %>% 
      select(-gini_cat) %>% 
      spread(key = wdes, value = gini_cat_se) %>% 
      mutate(bl = get(paste0(baseline_wd, "_", e))) %>% 
      mutate_at(vars(matches(e)),
                list(~sqrt(bl^2+.^2))) %>% 
      select(kcode, tcode, matches(e)) %>% 
      gather(key = wdes, value = rho_wd_se, -kcode, -tcode) %>% 
      filter(!is.na(rho_wd_se)) %>% 
      mutate(wd = str_replace(wdes, "_.*", "")) %>% 
      select(-wdes) %>% 
      arrange(kcode, tcode, wd)
  })
  
  rho_wd <- rho_wd0 %>% 
    bind_cols(rho_wd_se %>% select(rho_wd_se)) %>% 
    group_by(kcode, tcode, wd) %>%
    summarize(rho_wd_se0 = mean(rho_wd_se),
              rho_wd_se = ifelse(n() > 1,
                                 sqrt(mean(rho_wd_se^2) +
                                        (1 + 1/n()) * (1/(n() - 1)) * sum((rho_wd - mean(rho_wd))^2)),
                                 mean(rho_wd_se)),
              rho_wd = mean(rho_wd),
              .groups = "drop") %>%
    left_join(ineq %>% select(country, year, kcode, tcode, rcode, kbl) %>% distinct(),
              by = c("kcode", "tcode")) %>% 
    left_join(wecodes %>% select("wd", "wcode") %>% distinct(), by = "wd") %>% 
    mutate(kwcode = as.integer(factor(100*kcode+wcode)),
           rwcode = as.integer(factor(100*rcode+wcode)),
           kwd = paste(country, wd),
           rwd = paste(rcode, wd))
  
  rm(rho_wd0, rho_wd_se)
  
  rho_wd_kw <- rho_wd %>% 
    pull(kwd) %>% 
    unique()
  
  # generate ratios of baseline_es to each es (for all constant wd)
  wdes <- c("market", "gross", "disp", "con")
  if (str_detect(baseline_series, "market") & nbl == TRUE) {
    wdes <- "market"
  }
  rho_es0 <- map_df(c("market", "gross", "disp", "con"), function(w) {
    ineq1 %>%
      select(-gini_cat_se) %>%
      spread(key = wdes, value = gini_cat) %>%
      mutate(bl = get(paste0(w, "_", baseline_es))) %>%
      mutate_at(vars(matches(w)),
                list(~bl/.)) %>%
      select(kcode, tcode, matches(w)) %>%
      gather(key = wdes, value = rho_es, -kcode, -tcode) %>%
      filter(!is.na(rho_es)) %>%
      mutate(es = str_replace(wdes, ".*_", "")) %>%
      select(-wdes) %>%
      arrange(kcode, tcode, es)
  })
  
  rho_es_se <- map_df(c("market", "gross", "disp", "con"), function(w) {
    ineq1 %>%
      select(-gini_cat) %>%
      spread(key = wdes, value = gini_cat_se) %>%
      mutate(bl = get(paste0(w, "_", baseline_es))) %>%
      mutate_at(vars(matches(w)),
                list(~sqrt(bl^2+.^2))) %>%
      select(kcode, tcode, matches(w)) %>%
      gather(key = wdes, value = rho_es_se, -kcode, -tcode) %>%
      filter(!is.na(rho_es_se)) %>%
      mutate(es = str_replace(wdes, ".*_", "")) %>%
      select(-wdes) %>%
      arrange(kcode, tcode, es)
  })
  
  rho_es <- rho_es0 %>%
    bind_cols(rho_es_se %>% select(rho_es_se)) %>% 
    group_by(kcode, tcode, es) %>%
    summarize(rho_es_se = sqrt(mean(rho_es_se^2) +
                                 (1 + 1/n()) * 1/(n() - 1) * sum((rho_es - mean(rho_es))^2)),
              rho_es = mean(rho_es),
              .groups = "drop") %>%
    left_join(ineq %>% select(country, year, kcode, tcode, rcode, kbl) %>% distinct(),
              by = c("kcode", "tcode")) %>%
    left_join(wecodes %>% select("es", "ecode") %>% distinct(), by = "es") %>%
    mutate(kecode = as.integer(factor(100*kcode+ecode)),
           recode = as.integer(factor(100*rcode+ecode)),
           kes = paste(country, es),
           res = paste(rcode, es))
  
  rm(rho_es0, rho_es_se)
  
  rho_es_ke <- rho_es %>%
    pull(kes) %>%
    unique()
  
  kyrs <- ineq %>%
    group_by(kcode) %>%
    summarize(firstyr = min(year),
              lastyr = max(year),
              n_yrs = year %>% unique() %>% length(),
              dplyr.summarise.inform = FALSE) %>% 
    ungroup()
  
  ineq2 <- ineq %>% 
    left_join(kyrs, by = "kcode") %>% 
    mutate(scode = as.integer(factor(series, levels = unique(series))),
           kwd = paste(country, str_replace(wdes, "_.*", "")),
           kes = paste(country, str_replace(wdes, ".*_", "")),
           rwd = paste(rcode, str_replace(wdes, "_.*", "")),
           res = paste(rcode, str_replace(wdes, ".*_", "")),
           kw = (kwd %in% rho_wd_kw),
           ke = (kes %in% rho_es_ke)) %>% 
    left_join(rho_wd %>% select(kwd, kwcode) %>% unique(), by = "kwd") %>% 
    left_join(rho_wd %>% select(rwd, rwcode) %>% unique(), by = "rwd") %>% 
    left_join(rho_es %>% select(kes, kecode) %>% unique(), by = "kes") %>% 
    left_join(rho_es %>% select(res, recode) %>% unique(), by = "res") %>% 
    mutate(kwcode = if_else(is.na(kwcode), 0L, kwcode),
           kecode = if_else(is.na(kecode), 0L, kecode)) %>% 
    arrange(desc(ibl), desc(bl), desc(s_bl_obs), desc(kbl), desc(kw), desc(ke), 
            desc(r_bl_obs), region, 
            desc(k_bl_obs), desc(country_obs), country,
            wdes, series) %>% 
    filter(!is.na(rcode))
  
  return(list(ineq2, rho_we, rho_wd, ineq0))
}

disp <- make_inputs("LIS disp sqrt")
ineq2 <- disp[[1]]
rho_we <- disp[[2]]
rho_wd <- disp[[3]]

market <- make_inputs("LIS market sqrt")
ineq2_m <- market[[1]]
rho_we_m <- market[[2]]
rho_wd_m <- market[[3]]

## Save
swiid_source <- disp[[4]] %>% 
  rename(gini = gini_m,
         gini_se = gini_m_se) %>%
  mutate(year = as.integer(year)) %>% 
  select(-country_obs, -series_obs, -region) %>% 
  arrange(country, year, series)

rm(disp, market)
write_csv(swiid_source, "data/swiid_source.csv", na = "")
write_csv(swiid_source, "../SWIIDweb_source/swiid_source.csv", na = "")
save.image(file = "data/ineq0.rda")
save(list = c("ineq2", "rho_we", "rho_wd", "ineq2_m", "rho_we_m", "rho_wd_m"), file = "data/ineq.rda")
beepr::beep()
